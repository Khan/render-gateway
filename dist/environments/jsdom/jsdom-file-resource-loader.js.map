{"version":3,"file":"jsdom-file-resource-loader.js","names":["_fs","_interopRequireDefault","require","_path","_util","_jsdom","_wonderStuffCore","_applyAbortablePromisesPatch","obj","__esModule","default","_defineProperty","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","arg","_toPrimitive","String","input","hint","prim","Symbol","toPrimitive","undefined","res","call","TypeError","Number","readFileAsync","promisify","fs","readFile","JSDOMFileResourceLoader","ResourceLoader","constructor","rootFolder","applyAbortablePromisesPatch","url","path","isAbsolute","parsedURL","URL","normalize","join","_rootFolder","pathname","e","existsSync","KindError","Errors","NotFound","fetch","options","filePath","_makeFilePath","exports"],"sources":["../../../src/environments/jsdom/jsdom-file-resource-loader.js"],"sourcesContent":["// @flow\nimport fs from \"fs\";\nimport path from \"path\";\nimport {promisify} from \"util\";\nimport {ResourceLoader} from \"jsdom\";\nimport type {FetchOptions} from \"jsdom\";\nimport {KindError, Errors} from \"@khanacademy/wonder-stuff-core\";\nimport {applyAbortablePromisesPatch} from \"./apply-abortable-promises-patch.js\";\n\nconst readFileAsync = promisify(fs.readFile);\n\n/**\n * A ResourceLoader implementation for JSDOM that loads files from disk.\n */\nexport class JSDOMFileResourceLoader extends ResourceLoader {\n    _rootFolder: string;\n\n    /**\n     * Create instance of the resource loader.\n     *\n     * @param {string} rootFolder\n     * The root of where we will load files.\n     */\n    constructor(rootFolder: string) {\n        // Patch before super to make sure promises get an abort.\n        applyAbortablePromisesPatch();\n\n        super();\n\n        if (!fs.existsSync(rootFolder)) {\n            throw new KindError(\"Root folder cannot be found\", Errors.NotFound);\n        }\n\n        this._rootFolder = rootFolder;\n    }\n\n    _makeFilePath: (string) => string = (url) => {\n        /**\n         * If the url is a url, we are going to use it as a file path from root.\n         *\n         * If it is an absolute path, we just use it, otherwise we treat it\n         * as a relative path from root.\n         */\n        if (path.isAbsolute(url)) {\n            return url;\n        }\n\n        try {\n            const parsedURL = new URL(url);\n            return path.normalize(\n                path.join(this._rootFolder, parsedURL.pathname),\n            );\n        } catch (e) {\n            /* nothing */\n        }\n\n        // Assume relative path\n        return path.normalize(path.join(this._rootFolder, url));\n    };\n\n    fetch(url: string, options?: FetchOptions): ?Promise<Buffer> {\n        const filePath = this._makeFilePath(url);\n        return readFileAsync(filePath);\n    }\n}\n"],"mappings":";;;;;;AACA,IAAAA,GAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,KAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,KAAA,GAAAF,OAAA;AACA,IAAAG,MAAA,GAAAH,OAAA;AAEA,IAAAI,gBAAA,GAAAJ,OAAA;AACA,IAAAK,4BAAA,GAAAL,OAAA;AAAgF,SAAAD,uBAAAO,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,gBAAAH,GAAA,EAAAI,GAAA,EAAAC,KAAA,IAAAD,GAAA,GAAAE,cAAA,CAAAF,GAAA,OAAAA,GAAA,IAAAJ,GAAA,IAAAO,MAAA,CAAAC,cAAA,CAAAR,GAAA,EAAAI,GAAA,IAAAC,KAAA,EAAAA,KAAA,EAAAI,UAAA,QAAAC,YAAA,QAAAC,QAAA,oBAAAX,GAAA,CAAAI,GAAA,IAAAC,KAAA,WAAAL,GAAA;AAAA,SAAAM,eAAAM,GAAA,QAAAR,GAAA,GAAAS,YAAA,CAAAD,GAAA,2BAAAR,GAAA,gBAAAA,GAAA,GAAAU,MAAA,CAAAV,GAAA;AAAA,SAAAS,aAAAE,KAAA,EAAAC,IAAA,eAAAD,KAAA,iBAAAA,KAAA,kBAAAA,KAAA,MAAAE,IAAA,GAAAF,KAAA,CAAAG,MAAA,CAAAC,WAAA,OAAAF,IAAA,KAAAG,SAAA,QAAAC,GAAA,GAAAJ,IAAA,CAAAK,IAAA,CAAAP,KAAA,EAAAC,IAAA,2BAAAK,GAAA,sBAAAA,GAAA,YAAAE,SAAA,4DAAAP,IAAA,gBAAAF,MAAA,GAAAU,MAAA,EAAAT,KAAA;AAEhF,MAAMU,aAAa,GAAG,IAAAC,eAAS,EAACC,WAAE,CAACC,QAAQ,CAAC;;AAE5C;AACA;AACA;AACO,MAAMC,uBAAuB,SAASC,qBAAc,CAAC;EAGxD;AACJ;AACA;AACA;AACA;AACA;EACIC,WAAWA,CAACC,UAAkB,EAAE;IAC5B;IACA,IAAAC,wDAA2B,GAAE;IAE7B,KAAK,EAAE;IAAC9B,eAAA;IAAAA,eAAA,wBASyB+B,GAAG,IAAK;MACzC;AACR;AACA;AACA;AACA;AACA;MACQ,IAAIC,aAAI,CAACC,UAAU,CAACF,GAAG,CAAC,EAAE;QACtB,OAAOA,GAAG;MACd;MAEA,IAAI;QACA,MAAMG,SAAS,GAAG,IAAIC,GAAG,CAACJ,GAAG,CAAC;QAC9B,OAAOC,aAAI,CAACI,SAAS,CACjBJ,aAAI,CAACK,IAAI,CAAC,IAAI,CAACC,WAAW,EAAEJ,SAAS,CAACK,QAAQ,CAAC,CAClD;MACL,CAAC,CAAC,OAAOC,CAAC,EAAE;QACR;MAAA;;MAGJ;MACA,OAAOR,aAAI,CAACI,SAAS,CAACJ,aAAI,CAACK,IAAI,CAAC,IAAI,CAACC,WAAW,EAAEP,GAAG,CAAC,CAAC;IAC3D,CAAC;IA7BG,IAAI,CAACP,WAAE,CAACiB,UAAU,CAACZ,UAAU,CAAC,EAAE;MAC5B,MAAM,IAAIa,0BAAS,CAAC,6BAA6B,EAAEC,uBAAM,CAACC,QAAQ,CAAC;IACvE;IAEA,IAAI,CAACN,WAAW,GAAGT,UAAU;EACjC;EA0BAgB,KAAKA,CAACd,GAAW,EAAEe,OAAsB,EAAoB;IACzD,MAAMC,QAAQ,GAAG,IAAI,CAACC,aAAa,CAACjB,GAAG,CAAC;IACxC,OAAOT,aAAa,CAACyB,QAAQ,CAAC;EAClC;AACJ;AAACE,OAAA,CAAAvB,uBAAA,GAAAA,uBAAA"}