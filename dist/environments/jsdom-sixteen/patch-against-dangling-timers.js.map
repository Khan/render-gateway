{"version":3,"file":"patch-against-dangling-timers.js","names":["makeGate","gateOpen","open","close","isOpen","makeSingleWarningPatchFn","warned","obj","fnName","gate","old","callback","args","gatedCallback","console","warn","patchAgainstDanglingTimers","objToPatch","patchCallbackFnWithGate","exports"],"sources":["../../../src/environments/jsdom-sixteen/patch-against-dangling-timers.js"],"sourcesContent":["// @flow\nimport type {IGate, ITimerAPI} from \"./types.js\";\n\n/**\n * Make a gate that can be open and closed.\n * Default open.\n */\nconst makeGate = (): IGate => {\n    let gateOpen = true;\n    return {\n        open: () => {\n            gateOpen = true;\n        },\n        close: () => {\n            gateOpen = false;\n        },\n        get isOpen(): boolean {\n            return gateOpen;\n        },\n    };\n};\n\n/**\n * Return a function that patches timeout functions with shared warning.\n *\n * This returns a call that, when used to patch setTimeout, setInterval, etc.\n * will only warn once if any of the patched functions invokes a callback\n * after the given gate is closed.\n */\nconst makeSingleWarningPatchFn = () => {\n    let warned = false;\n    return (obj: any, fnName: string, gate: IGate): void => {\n        const old = obj[fnName];\n        delete obj[fnName];\n        obj[fnName] = (callback, ...args) => {\n            const gatedCallback = () => {\n                if (gate.isOpen) {\n                    callback();\n                    return;\n                }\n                if (!warned) {\n                    warned = true;\n                    /**\n                     * This uses console because it runs in the VM, so it\n                     * doesn't have direct access to our winston logging.\n                     * Our virtual JSDOM console manages that.\n                     */\n                    // eslint-disable-next-line no-console\n                    console.warn(\"Dangling timer(s) detected\");\n                }\n            };\n            return old(gatedCallback, ...args);\n        };\n    };\n};\n\n/**\n * Patch the timer API to protect against dangling timers.\n *\n * @returns {IGate} A gate API to control when timers should be allowed to run\n * (gate is open), or when we should prevent them running and report dangling\n * timers (gate is closed).\n */\nexport const patchAgainstDanglingTimers = (objToPatch: ITimerAPI): IGate => {\n    /**\n     * Make a gate so we can control how the timers are handled.\n     * The gate is default open.\n     */\n    const gate = makeGate();\n\n    /**\n     * Get a patch function with single warning.\n     * This ensures that each of the patched functions will only warn of\n     * dangling timers if none of the others have warned already.\n     * This keeps the log a little tidier and manageable.\n     */\n    const patchCallbackFnWithGate = makeSingleWarningPatchFn();\n\n    /**\n     * Patch the timer functions on window so that dangling timers don't kill\n     * us when we close the window.\n     */\n    patchCallbackFnWithGate(objToPatch, \"setTimeout\", gate);\n    patchCallbackFnWithGate(objToPatch, \"setInterval\", gate);\n    patchCallbackFnWithGate(objToPatch, \"requestAnimationFrame\", gate);\n\n    return gate;\n};\n"],"mappings":";;;;;;AAGA;AACA;AACA;AACA;AACA,MAAMA,QAAQ,GAAGA,CAAA,KAAa;EAC1B,IAAIC,QAAQ,GAAG,IAAI;EACnB,OAAO;IACHC,IAAI,EAAEA,CAAA,KAAM;MACRD,QAAQ,GAAG,IAAI;IACnB,CAAC;IACDE,KAAK,EAAEA,CAAA,KAAM;MACTF,QAAQ,GAAG,KAAK;IACpB,CAAC;IACD,IAAIG,MAAMA,CAAA,EAAY;MAClB,OAAOH,QAAQ;IACnB;EACJ,CAAC;AACL,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMI,wBAAwB,GAAGA,CAAA,KAAM;EACnC,IAAIC,MAAM,GAAG,KAAK;EAClB,OAAO,CAACC,GAAQ,EAAEC,MAAc,EAAEC,IAAW,KAAW;IACpD,MAAMC,GAAG,GAAGH,GAAG,CAACC,MAAM,CAAC;IACvB,OAAOD,GAAG,CAACC,MAAM,CAAC;IAClBD,GAAG,CAACC,MAAM,CAAC,GAAG,CAACG,QAAQ,EAAE,GAAGC,IAAI,KAAK;MACjC,MAAMC,aAAa,GAAGA,CAAA,KAAM;QACxB,IAAIJ,IAAI,CAACL,MAAM,EAAE;UACbO,QAAQ,EAAE;UACV;QACJ;QACA,IAAI,CAACL,MAAM,EAAE;UACTA,MAAM,GAAG,IAAI;UACb;AACpB;AACA;AACA;AACA;UACoB;UACAQ,OAAO,CAACC,IAAI,CAAC,4BAA4B,CAAC;QAC9C;MACJ,CAAC;MACD,OAAOL,GAAG,CAACG,aAAa,EAAE,GAAGD,IAAI,CAAC;IACtC,CAAC;EACL,CAAC;AACL,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMI,0BAA0B,GAAIC,UAAqB,IAAY;EACxE;AACJ;AACA;AACA;EACI,MAAMR,IAAI,GAAGT,QAAQ,EAAE;;EAEvB;AACJ;AACA;AACA;AACA;AACA;EACI,MAAMkB,uBAAuB,GAAGb,wBAAwB,EAAE;;EAE1D;AACJ;AACA;AACA;EACIa,uBAAuB,CAACD,UAAU,EAAE,YAAY,EAAER,IAAI,CAAC;EACvDS,uBAAuB,CAACD,UAAU,EAAE,aAAa,EAAER,IAAI,CAAC;EACxDS,uBAAuB,CAACD,UAAU,EAAE,uBAAuB,EAAER,IAAI,CAAC;EAElE,OAAOA,IAAI;AACf,CAAC;AAACU,OAAA,CAAAH,0BAAA,GAAAA,0BAAA"}