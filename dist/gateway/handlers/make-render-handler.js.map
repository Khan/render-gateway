{"version":3,"sources":["../../../src/gateway/handlers/make-render-handler.js"],"names":["renderHandler","renderFn","req","res","logger","trackHeaderLookup","name","header","traceFn","renderURL","query","url","Error","renderAPI","getHeader","trace","body","status","send","e","error","json","makeRenderHandler"],"mappings":";;;;;;;AAEA;;AACA;;;;;;;;AAIA;;;;;;;;;AASA,eAAeA,aAAf,CACIC,QADJ,EAEIC,GAFJ,EAGIC,GAHJ,EAIiB;AACb,QAAMC,MAAM,GAAG,uBAAUF,GAAV,CAAf;AAEA;;;;;;AAKA,QAAMG,iBAAiB,GAAIC,IAAD,IAA2B;AACjD,WAAOJ,GAAG,CAACK,MAAJ,CAAWD,IAAX,CAAP;AACH,GAFD;AAIA;;;;;;;;AAMA,QAAME,OAAO,GAAIF,IAAD,IAAiC,mBAAMA,IAAN,EAAYJ,GAAZ,CAAjD;AAEA;;;;;AAGA,QAAMO,SAAS,GAAGP,GAAG,CAACQ,KAAJ,CAAUC,GAA5B;;AACA,MAAI,OAAOF,SAAP,KAAqB,QAAzB,EAAmC;AAC/B,QAAIA,SAAS,IAAI,IAAjB,EAAuB;AACnB,YAAM,IAAIG,KAAJ,CAAW,yBAAX,CAAN;AACH;;AACD,UAAM,IAAIA,KAAJ,CAAW,qCAAX,CAAN;AACH;;AACD,MAAI;AACA;;;AAGA,UAAMC,SAAoB,GAAG;AACzBC,MAAAA,SAAS,EAAET,iBADc;AAEzBU,MAAAA,KAAK,EAAEP,OAFkB;AAGzBJ,MAAAA;AAHyB,KAA7B;AAMA;;;;AAGA,UAAM;AAACY,MAAAA,IAAD;AAAOC,MAAAA;AAAP,QAAiB,MAAMhB,QAAQ,CAACQ,SAAD,EAAYI,SAAZ,CAArC;AAEA;;;;;;;;;;AAWA;AACA;;AACAV,IAAAA,GAAG,CAACc,MAAJ,CAAWA,MAAX;AACAd,IAAAA,GAAG,CAACe,IAAJ,CAASF,IAAT;AACH,GA9BD,CA8BE,OAAOG,CAAP,EAAU;AACR;;;AAGA,UAAMC,KAAK,GAAG,yBAAaD,CAAb,CAAd;AAEAf,IAAAA,MAAM,CAACgB,KAAP,CAAa,eAAb,oBAAkCA,KAAlC;AAAyCX,MAAAA;AAAzC;AACAN,IAAAA,GAAG,CAACc,MAAJ,CAAW,GAAX,EAAgBI,IAAhB,CAAqBD,KAArB;AACH;AACJ;AAED;;;;;;;;;;;;AAUO,MAAME,iBAAiB,GAC1BrB,QAD6B,IAEG,CAChCC,GADgC,EAEhCC,GAFgC,KAGhBH,aAAa,CAACC,QAAD,EAAWC,GAAX,EAAgBC,GAAhB,CAL1B","sourcesContent":["// @flow\nimport type {Middleware} from \"express\";\nimport {extractError} from \"../../shared/index.js\";\nimport {getLogger, trace} from \"../../ka-shared/index.js\";\nimport type {ITraceSession} from \"../../shared/index.js\";\nimport type {Request, Response, RenderCallback, RenderAPI} from \"../types.js\";\n\n/**\n * Handle a request as a render.\n *\n * This method orchestrates the download and setup of a render environment\n * and the subsequent rendering process. The downloaded code is responsible for\n * the actual render operation.\n *\n * This is expected to be wrapped with express-async-handler.\n */\nasync function renderHandler(\n    renderFn: RenderCallback,\n    req: Request,\n    res: Response,\n): Promise<void> {\n    const logger = getLogger(req);\n\n    /**\n     * TODO(somewhatabstract, WEB-1108): Actually track headers and build vary\n     * header.\n     * Encapsulate in other code to make it easily tested.\n     */\n    const trackHeaderLookup = (name: string): ?string => {\n        return req.header(name);\n    };\n\n    /**\n     * TODO(somewhatabstract, WEB-2057): Hook in tracing (make sure that we\n     * don't leave trace sessions open on rejection (or otherwise)).\n     *\n     * For now, we'll assume callers will tidy up.\n     */\n    const traceFn = (name: string): ITraceSession => trace(name, req);\n\n    /**\n     * The URL being rendered is given in a query param named, url.\n     */\n    const renderURL = req.query.url;\n    if (typeof renderURL !== \"string\") {\n        if (renderURL == null) {\n            throw new Error(`Missing url query param`);\n        }\n        throw new Error(`More than one url query param given`);\n    }\n    try {\n        /**\n         * Put together the API we make available when rendering.\n         */\n        const renderAPI: RenderAPI = {\n            getHeader: trackHeaderLookup,\n            trace: traceFn,\n            logger,\n        };\n\n        /**\n         * Defer this bit to the render callback.\n         */\n        const {body, status} = await renderFn(renderURL, renderAPI);\n\n        /**\n         * TODO(somewhatabstract, WEB-1108): Validate the status with the\n         * headers.\n         * There are a couple where we know we need certain things to match\n         * 1. If a Vary header is included, we should error to indicate that\n         *    is not allowed\n         * 2. For 301/302 status, we need a `Location` header.\n         *\n         * validateStatusAndHeaders(status, headers);\n         */\n\n        // TODO(somewhatabstract, WEB-1108): Add headers.\n        // TODO(somewhatabstract, WEB-1108): Add Vary header.\n        res.status(status);\n        res.send(body);\n    } catch (e) {\n        /**\n         * Something went wrong. Let's report it!\n         */\n        const error = extractError(e);\n\n        logger.error(\"Render failed\", {...error, renderURL});\n        res.status(500).json(error);\n    }\n}\n\n/**\n * Create a render handler.\n *\n * This creates a handler for use with express. The created handler manages\n * executing the render process, a part of which involves invoking the given\n * render function.\n *\n * @param {RenderCallback} renderFn The function that is responsible for\n * performing the render operation.\n */\nexport const makeRenderHandler = (\n    renderFn: RenderCallback,\n): Middleware<Request, Response> => (\n    req: Request,\n    res: Response,\n): Promise<void> => renderHandler(renderFn, req, res);\n"],"file":"make-render-handler.js"}