{"version":3,"sources":["../../../src/gateway/handlers/handle-error.js"],"names":["handleError","overallProblem","errorHandler","req","res","error","logger","simplifiedError","status","requestURL","query","url","overriddenResponse","headers","send","e2","innerError","originalError","json"],"mappings":";;;;;;;AACA;;AACA;;;;;;;;AAIA;;;;;;;;;;;;;AAaO,MAAMA,WAAW,GAAG,CACvBC,cADuB,EAEvBC,YAFuB,EAGvBC,GAHuB,EAIvBC,GAJuB,EAKvBC,KALuB,KAMhB;AACP,QAAMC,MAAM,GAAG,uBAAUH,GAAV,CAAf;AACA;;;;AAGA,QAAMI,eAAe,GAAG,yBAAaF,KAAb,CAAxB;AAEA;;;;AAGAD,EAAAA,GAAG,CAACI,MAAJ,CAAW,GAAX;AAEA;;;;;AAIA,QAAMC,UAAU,GAAG,OAAON,GAAG,CAACO,KAAJ,CAAUC,GAAjB,KAAyB,QAAzB,GAAoCR,GAAG,CAACO,KAAJ,CAAUC,GAA9C,GAAoD,EAAvE;AAEA;;;;;AAIA,MAAI;AACA,UAAMC,kBAAkB,GAAGV,YAAH,aAAGA,YAAH,uBAAGA,YAAY,CACnCO,UADmC,EAEnCN,GAAG,CAACU,OAF+B,EAGnCN,eAHmC,CAAvC;;AAKA,QAAIK,kBAAkB,IAAI,IAA1B,EAAgC;AAC5BN,MAAAA,MAAM,CAACD,KAAP,CAAc,GAAEJ,cAAe,mCAA/B,oBACOM,eADP;AAEIE,QAAAA;AAFJ;AAIAL,MAAAA,GAAG,CAACU,IAAJ,CAASF,kBAAT;AACA;AACH;AACJ,GAdD,CAcE,OAAOG,EAAP,EAAW;AACT;;;;AAIA,UAAMC,UAAU,GAAG,yBAAaD,EAAb,CAAnB;AACAT,IAAAA,MAAM,CAACD,KAAP,CAAc,GAAEJ,cAAe,yBAA/B,oBACOe,UADP;AAEIC,MAAAA,aAAa,EAAEV,eAFnB;AAGIE,MAAAA;AAHJ;AAKAL,IAAAA,GAAG,CAACc,IAAJ,mBACOF,UADP;AAEIC,MAAAA,aAAa,EAAEV;AAFnB;AAIA;AACH;AAED;;;;;;AAIAD,EAAAA,MAAM,CAACD,KAAP,CAAc,GAAEJ,cAAe,kBAA/B,oBACOM,eADP;AAEIE,IAAAA;AAFJ;AAIAL,EAAAA,GAAG,CAACc,IAAJ,CAASX,eAAT;AACH,CArEM","sourcesContent":["// @flow\nimport {extractError} from \"../../shared/index.js\";\nimport {getLogger} from \"../../ka-shared/index.js\";\nimport type {AmbiguousError} from \"../../shared/index.js\";\nimport type {Request, Response, CustomErrorHandlerFn} from \"../types.js\";\n\n/**\n * Handle an ambiguous error and determine an appropriate response.\n *\n * @param {string} overallProblem A simple description of what problem the error\n * explains.\n * @param {?CustomErrorHandlerFn} errorHandler A possible custom error handler\n * that can generate a response for the error.\n * @param {Request} req The request that was being handled when the error\n * occurred.\n * @param {Response} res The response that is being generated and to which the\n * error is reported.\n * @param {AmbiguousError} error The error that is to be handled.\n */\nexport const handleError = (\n    overallProblem: string,\n    errorHandler: ?CustomErrorHandlerFn,\n    req: Request,\n    res: Response,\n    error: AmbiguousError,\n): void => {\n    const logger = getLogger(req);\n    /**\n     * Something went wrong. Let's report it!\n     */\n    const simplifiedError = extractError(error);\n\n    /**\n     * We're definitely returning an error for this one.\n     */\n    res.status(500);\n\n    /**\n     * The calling code should handle if the original request was valid or\n     * not, so we just appease flow here.\n     */\n    const requestURL = typeof req.query.url === \"string\" ? req.query.url : \"\";\n\n    /**\n     * Before we return the basic 500 error, let's give our configuration\n     * chance to make a nicer error page.\n     */\n    try {\n        const overriddenResponse = errorHandler?.(\n            requestURL,\n            req.headers,\n            simplifiedError,\n        );\n        if (overriddenResponse != null) {\n            logger.error(`${overallProblem}; custom error response generated`, {\n                ...simplifiedError,\n                requestURL,\n            });\n            res.send(overriddenResponse);\n            return;\n        }\n    } catch (e2) {\n        /**\n         * Oh no, our configuration threw too!\n         * Ouch. We should report this.\n         */\n        const innerError = extractError(e2);\n        logger.error(`${overallProblem}; custom handler failed`, {\n            ...innerError,\n            originalError: simplifiedError,\n            requestURL,\n        });\n        res.json({\n            ...innerError,\n            originalError: simplifiedError,\n        });\n        return;\n    }\n\n    /**\n     * This is the default response if there was no error handler or the\n     * error handler didn't provide an override response.\n     */\n    logger.error(`${overallProblem}; uncaught error`, {\n        ...simplifiedError,\n        requestURL,\n    });\n    res.json(simplifiedError);\n};\n"],"file":"handle-error.js"}