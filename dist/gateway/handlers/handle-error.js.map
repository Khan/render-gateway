{"version":3,"file":"handle-error.js","names":["handleError","overallProblem","errorHandler","defaultErrorResponse","req","res","error","logger","simplifiedError","status","requestURL","query","url","overriddenResponse","headers","body","kind","Errors","TransientKhanService","header","send","customHandlerError","innerError","originalError"],"sources":["../../../src/gateway/handlers/handle-error.js"],"sourcesContent":["// @flow\nimport {extractError, getLogger} from \"../../shared/index.js\";\nimport {Errors} from \"../../ka-shared/index.js\";\nimport {formatError} from \"../format-error.js\";\nimport type {AmbiguousError} from \"../../shared/index.js\";\nimport type {Request, Response, CustomErrorHandlerFn} from \"../types.js\";\n\n/**\n * Handle an ambiguous error and determine an appropriate response.\n *\n * @param {string} overallProblem A simple description of what problem the error\n * explains.\n * @param {?CustomErrorHandlerFn} errorHandler A possible custom error handler\n * that can generate a response for the error.\n * @param {Request} req The request that was being handled when the error\n * occurred.\n * @param {Response} res The response that is being generated and to which the\n * error is reported.\n * @param {AmbiguousError} error The error that is to be handled.\n */\nexport const handleError = async (\n    overallProblem: string,\n    errorHandler: ?CustomErrorHandlerFn,\n    defaultErrorResponse: ?string,\n    req: Request,\n    res: Response,\n    error: AmbiguousError,\n): Promise<void> => {\n    const logger = getLogger(req);\n    /**\n     * Something went wrong. Let's report it!\n     */\n    const simplifiedError = extractError(error);\n\n    /**\n     * We're definitely returning an error for this one.\n     */\n    res.status(500);\n\n    /**\n     * The calling code should handle if the original request was valid or\n     * not, so we just appease flow here.\n     */\n    const requestURL = typeof req.query.url === \"string\" ? req.query.url : \"\";\n\n    /**\n     * Before we return the basic 500 error, let's give our configuration a\n     * chance to make a nicer error page.\n     */\n    try {\n        const overriddenResponse = await errorHandler?.(\n            requestURL,\n            req.headers,\n            simplifiedError,\n        );\n        if (overriddenResponse != null) {\n            const {body, headers} = overriddenResponse;\n            logger.error(`${overallProblem}; custom error response generated`, {\n                ...simplifiedError,\n                requestURL,\n                kind: Errors.TransientKhanService,\n            });\n            res.header(headers);\n            res.send(body);\n            return;\n        }\n    } catch (customHandlerError) {\n        /**\n         * Oh no, our configuration threw too!\n         * Ouch. We should report this.\n         */\n        const innerError = extractError(customHandlerError);\n        logger.error(`${overallProblem}; custom handler failed`, {\n            ...innerError,\n            originalError: simplifiedError,\n            requestURL,\n            kind: Errors.TransientKhanService,\n        });\n        res.send(\n            formatError(defaultErrorResponse, {\n                ...innerError,\n                originalError: simplifiedError,\n            }),\n        );\n        return;\n    }\n\n    /**\n     * This is the default response if there was no error handler or the\n     * error handler didn't provide an override response.\n     */\n    logger.error(`${overallProblem}; uncaught error`, {\n        ...simplifiedError,\n        requestURL,\n        kind: Errors.TransientKhanService,\n    });\n    res.send(formatError(defaultErrorResponse, simplifiedError));\n};\n"],"mappings":";;;;;;;AACA;;AACA;;AACA;;;;;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,WAAW,GAAG,OACvBC,cADuB,EAEvBC,YAFuB,EAGvBC,oBAHuB,EAIvBC,GAJuB,EAKvBC,GALuB,EAMvBC,KANuB,KAOP;EAChB,MAAMC,MAAM,GAAG,sBAAUH,GAAV,CAAf;EACA;AACJ;AACA;;EACI,MAAMI,eAAe,GAAG,yBAAaF,KAAb,CAAxB;EAEA;AACJ;AACA;;EACID,GAAG,CAACI,MAAJ,CAAW,GAAX;EAEA;AACJ;AACA;AACA;;EACI,MAAMC,UAAU,GAAG,OAAON,GAAG,CAACO,KAAJ,CAAUC,GAAjB,KAAyB,QAAzB,GAAoCR,GAAG,CAACO,KAAJ,CAAUC,GAA9C,GAAoD,EAAvE;EAEA;AACJ;AACA;AACA;;EACI,IAAI;IACA,MAAMC,kBAAkB,GAAG,OAAMX,YAAN,aAAMA,YAAN,uBAAMA,YAAY,CACzCQ,UADyC,EAEzCN,GAAG,CAACU,OAFqC,EAGzCN,eAHyC,CAAlB,CAA3B;;IAKA,IAAIK,kBAAkB,IAAI,IAA1B,EAAgC;MAC5B,MAAM;QAACE,IAAD;QAAOD;MAAP,IAAkBD,kBAAxB;MACAN,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,mCAA/B,kCACOO,eADP;QAEIE,UAFJ;QAGIM,IAAI,EAAEC,eAAOC;MAHjB;MAKAb,GAAG,CAACc,MAAJ,CAAWL,OAAX;MACAT,GAAG,CAACe,IAAJ,CAASL,IAAT;MACA;IACH;EACJ,CAjBD,CAiBE,OAAOM,kBAAP,EAA2B;IACzB;AACR;AACA;AACA;IACQ,MAAMC,UAAU,GAAG,yBAAaD,kBAAb,CAAnB;IACAd,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,yBAA/B,kCACOqB,UADP;MAEIC,aAAa,EAAEf,eAFnB;MAGIE,UAHJ;MAIIM,IAAI,EAAEC,eAAOC;IAJjB;IAMAb,GAAG,CAACe,IAAJ,CACI,8BAAYjB,oBAAZ,kCACOmB,UADP;MAEIC,aAAa,EAAEf;IAFnB,GADJ;IAMA;EACH;EAED;AACJ;AACA;AACA;;;EACID,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,kBAA/B,kCACOO,eADP;IAEIE,UAFJ;IAGIM,IAAI,EAAEC,eAAOC;EAHjB;EAKAb,GAAG,CAACe,IAAJ,CAAS,8BAAYjB,oBAAZ,EAAkCK,eAAlC,CAAT;AACH,CA7EM"}