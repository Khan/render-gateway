{"version":3,"sources":["../../../src/gateway/handlers/handle-error.js"],"names":["handleError","overallProblem","errorHandler","defaultErrorResponse","req","res","error","logger","simplifiedError","status","requestURL","query","url","overriddenResponse","headers","body","kind","Errors","TransientKhanService","header","send","customHandlerError","innerError","originalError"],"mappings":";;;;;;;AACA;;AACA;;AACA;;;;;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,WAAW,GAAG,CACvBC,cADuB,EAEvBC,YAFuB,EAGvBC,oBAHuB,EAIvBC,GAJuB,EAKvBC,GALuB,EAMvBC,KANuB,KAOhB;AACP,QAAMC,MAAM,GAAG,sBAAUH,GAAV,CAAf;AACA;AACJ;AACA;;AACI,QAAMI,eAAe,GAAG,yBAAaF,KAAb,CAAxB;AAEA;AACJ;AACA;;AACID,EAAAA,GAAG,CAACI,MAAJ,CAAW,GAAX;AAEA;AACJ;AACA;AACA;;AACI,QAAMC,UAAU,GAAG,OAAON,GAAG,CAACO,KAAJ,CAAUC,GAAjB,KAAyB,QAAzB,GAAoCR,GAAG,CAACO,KAAJ,CAAUC,GAA9C,GAAoD,EAAvE;AAEA;AACJ;AACA;AACA;;AACI,MAAI;AACA,UAAMC,kBAAkB,GAAGX,YAAH,aAAGA,YAAH,uBAAGA,YAAY,CACnCQ,UADmC,EAEnCN,GAAG,CAACU,OAF+B,EAGnCN,eAHmC,CAAvC;;AAKA,QAAIK,kBAAkB,IAAI,IAA1B,EAAgC;AAC5B,YAAM;AAACE,QAAAA,IAAD;AAAOD,QAAAA;AAAP,UAAkBD,kBAAxB;AACAN,MAAAA,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,mCAA/B,kCACOO,eADP;AAEIE,QAAAA,UAFJ;AAGIM,QAAAA,IAAI,EAAEC,eAAOC;AAHjB;AAKAb,MAAAA,GAAG,CAACc,MAAJ,CAAWL,OAAX;AACAT,MAAAA,GAAG,CAACe,IAAJ,CAASL,IAAT;AACA;AACH;AACJ,GAjBD,CAiBE,OAAOM,kBAAP,EAA2B;AACzB;AACR;AACA;AACA;AACQ,UAAMC,UAAU,GAAG,yBAAaD,kBAAb,CAAnB;AACAd,IAAAA,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,yBAA/B,kCACOqB,UADP;AAEIC,MAAAA,aAAa,EAAEf,eAFnB;AAGIE,MAAAA,UAHJ;AAIIM,MAAAA,IAAI,EAAEC,eAAOC;AAJjB;AAMAb,IAAAA,GAAG,CAACe,IAAJ,CACI,8BAAYjB,oBAAZ,kCACOmB,UADP;AAEIC,MAAAA,aAAa,EAAEf;AAFnB,OADJ;AAMA;AACH;AAED;AACJ;AACA;AACA;;;AACID,EAAAA,MAAM,CAACD,KAAP,CAAc,GAAEL,cAAe,kBAA/B,kCACOO,eADP;AAEIE,IAAAA,UAFJ;AAGIM,IAAAA,IAAI,EAAEC,eAAOC;AAHjB;AAKAb,EAAAA,GAAG,CAACe,IAAJ,CAAS,8BAAYjB,oBAAZ,EAAkCK,eAAlC,CAAT;AACH,CA7EM","sourcesContent":["// @flow\nimport {extractError, getLogger} from \"../../shared/index.js\";\nimport {Errors} from \"../../ka-shared/index.js\";\nimport {formatError} from \"../format-error.js\";\nimport type {AmbiguousError} from \"../../shared/index.js\";\nimport type {Request, Response, CustomErrorHandlerFn} from \"../types.js\";\n\n/**\n * Handle an ambiguous error and determine an appropriate response.\n *\n * @param {string} overallProblem A simple description of what problem the error\n * explains.\n * @param {?CustomErrorHandlerFn} errorHandler A possible custom error handler\n * that can generate a response for the error.\n * @param {Request} req The request that was being handled when the error\n * occurred.\n * @param {Response} res The response that is being generated and to which the\n * error is reported.\n * @param {AmbiguousError} error The error that is to be handled.\n */\nexport const handleError = (\n    overallProblem: string,\n    errorHandler: ?CustomErrorHandlerFn,\n    defaultErrorResponse: ?string,\n    req: Request,\n    res: Response,\n    error: AmbiguousError,\n): void => {\n    const logger = getLogger(req);\n    /**\n     * Something went wrong. Let's report it!\n     */\n    const simplifiedError = extractError(error);\n\n    /**\n     * We're definitely returning an error for this one.\n     */\n    res.status(500);\n\n    /**\n     * The calling code should handle if the original request was valid or\n     * not, so we just appease flow here.\n     */\n    const requestURL = typeof req.query.url === \"string\" ? req.query.url : \"\";\n\n    /**\n     * Before we return the basic 500 error, let's give our configuration a\n     * chance to make a nicer error page.\n     */\n    try {\n        const overriddenResponse = errorHandler?.(\n            requestURL,\n            req.headers,\n            simplifiedError,\n        );\n        if (overriddenResponse != null) {\n            const {body, headers} = overriddenResponse;\n            logger.error(`${overallProblem}; custom error response generated`, {\n                ...simplifiedError,\n                requestURL,\n                kind: Errors.TransientKhanService,\n            });\n            res.header(headers);\n            res.send(body);\n            return;\n        }\n    } catch (customHandlerError) {\n        /**\n         * Oh no, our configuration threw too!\n         * Ouch. We should report this.\n         */\n        const innerError = extractError(customHandlerError);\n        logger.error(`${overallProblem}; custom handler failed`, {\n            ...innerError,\n            originalError: simplifiedError,\n            requestURL,\n            kind: Errors.TransientKhanService,\n        });\n        res.send(\n            formatError(defaultErrorResponse, {\n                ...innerError,\n                originalError: simplifiedError,\n            }),\n        );\n        return;\n    }\n\n    /**\n     * This is the default response if there was no error handler or the\n     * error handler didn't provide an override response.\n     */\n    logger.error(`${overallProblem}; uncaught error`, {\n        ...simplifiedError,\n        requestURL,\n        kind: Errors.TransientKhanService,\n    });\n    res.send(formatError(defaultErrorResponse, simplifiedError));\n};\n"],"file":"handle-error.js"}