{"version":3,"file":"handle-error.js","names":["handleError","overallProblem","errorHandler","defaultErrorResponse","req","res","error","logger","getLogger","simplifiedError","extractError","status","requestURL","query","url","overriddenResponse","headers","body","kind","Errors","TransientKhanService","header","send","customHandlerError","innerError","originalError","formatError"],"sources":["../../../src/gateway/handlers/handle-error.js"],"sourcesContent":["// @flow\nimport {extractError, getLogger} from \"../../shared/index.js\";\nimport {Errors} from \"../../ka-shared/index.js\";\nimport {formatError} from \"../format-error.js\";\nimport type {AmbiguousError} from \"../../shared/index.js\";\nimport type {Request, Response, CustomErrorHandlerFn} from \"../types.js\";\n\n/**\n * Handle an ambiguous error and determine an appropriate response.\n *\n * @param {string} overallProblem A simple description of what problem the error\n * explains.\n * @param {?CustomErrorHandlerFn} errorHandler A possible custom error handler\n * that can generate a response for the error.\n * @param {Request} req The request that was being handled when the error\n * occurred.\n * @param {Response} res The response that is being generated and to which the\n * error is reported.\n * @param {AmbiguousError} error The error that is to be handled.\n */\nexport const handleError = async (\n    overallProblem: string,\n    errorHandler: ?CustomErrorHandlerFn,\n    defaultErrorResponse: ?string,\n    req: Request,\n    res: Response,\n    error: AmbiguousError,\n): Promise<void> => {\n    const logger = getLogger(req);\n    /**\n     * Something went wrong. Let's report it!\n     */\n    const simplifiedError = extractError(error);\n\n    /**\n     * We're definitely returning an error for this one.\n     */\n    res.status(500);\n\n    /**\n     * The calling code should handle if the original request was valid or\n     * not, so we just appease flow here.\n     */\n    const requestURL = typeof req.query.url === \"string\" ? req.query.url : \"\";\n\n    /**\n     * Before we return the basic 500 error, let's give our configuration a\n     * chance to make a nicer error page.\n     */\n    try {\n        const overriddenResponse = await errorHandler?.(\n            requestURL,\n            req.headers,\n            simplifiedError,\n        );\n        if (overriddenResponse != null) {\n            const {body, headers} = overriddenResponse;\n            logger.error(`${overallProblem}; custom error response generated`, {\n                ...simplifiedError,\n                requestURL,\n                kind: Errors.TransientKhanService,\n            });\n            res.header(headers);\n            res.send(body);\n            return;\n        }\n    } catch (customHandlerError) {\n        /**\n         * Oh no, our configuration threw too!\n         * Ouch. We should report this.\n         */\n        const innerError = extractError(customHandlerError);\n        logger.error(`${overallProblem}; custom handler failed`, {\n            ...innerError,\n            originalError: simplifiedError,\n            requestURL,\n            kind: Errors.TransientKhanService,\n        });\n        res.send(\n            formatError(defaultErrorResponse, {\n                ...innerError,\n                originalError: simplifiedError,\n            }),\n        );\n        return;\n    }\n\n    /**\n     * This is the default response if there was no error handler or the\n     * error handler didn't provide an override response.\n     */\n    logger.error(`${overallProblem}; uncaught error`, {\n        ...simplifiedError,\n        requestURL,\n        kind: Errors.TransientKhanService,\n    });\n    res.send(formatError(defaultErrorResponse, simplifiedError));\n};\n"],"mappings":";;;;;;AACA;AACA;AACA;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,WAAW,GAAG,OACvBC,cAAsB,EACtBC,YAAmC,EACnCC,oBAA6B,EAC7BC,GAAY,EACZC,GAAa,EACbC,KAAqB,KACL;EAChB,MAAMC,MAAM,GAAG,IAAAC,gBAAS,EAACJ,GAAG,CAAC;EAC7B;AACJ;AACA;EACI,MAAMK,eAAe,GAAG,IAAAC,mBAAY,EAACJ,KAAK,CAAC;;EAE3C;AACJ;AACA;EACID,GAAG,CAACM,MAAM,CAAC,GAAG,CAAC;;EAEf;AACJ;AACA;AACA;EACI,MAAMC,UAAU,GAAG,OAAOR,GAAG,CAACS,KAAK,CAACC,GAAG,KAAK,QAAQ,GAAGV,GAAG,CAACS,KAAK,CAACC,GAAG,GAAG,EAAE;;EAEzE;AACJ;AACA;AACA;EACI,IAAI;IACA,MAAMC,kBAAkB,GAAG,OAAMb,YAAY,aAAZA,YAAY,uBAAZA,YAAY,CACzCU,UAAU,EACVR,GAAG,CAACY,OAAO,EACXP,eAAe,CAClB;IACD,IAAIM,kBAAkB,IAAI,IAAI,EAAE;MAC5B,MAAM;QAACE,IAAI;QAAED;MAAO,CAAC,GAAGD,kBAAkB;MAC1CR,MAAM,CAACD,KAAK,CAAE,GAAEL,cAAe,mCAAkC,EAAE;QAC/D,GAAGQ,eAAe;QAClBG,UAAU;QACVM,IAAI,EAAEC,cAAM,CAACC;MACjB,CAAC,CAAC;MACFf,GAAG,CAACgB,MAAM,CAACL,OAAO,CAAC;MACnBX,GAAG,CAACiB,IAAI,CAACL,IAAI,CAAC;MACd;IACJ;EACJ,CAAC,CAAC,OAAOM,kBAAkB,EAAE;IACzB;AACR;AACA;AACA;IACQ,MAAMC,UAAU,GAAG,IAAAd,mBAAY,EAACa,kBAAkB,CAAC;IACnDhB,MAAM,CAACD,KAAK,CAAE,GAAEL,cAAe,yBAAwB,EAAE;MACrD,GAAGuB,UAAU;MACbC,aAAa,EAAEhB,eAAe;MAC9BG,UAAU;MACVM,IAAI,EAAEC,cAAM,CAACC;IACjB,CAAC,CAAC;IACFf,GAAG,CAACiB,IAAI,CACJ,IAAAI,wBAAW,EAACvB,oBAAoB,EAAE;MAC9B,GAAGqB,UAAU;MACbC,aAAa,EAAEhB;IACnB,CAAC,CAAC,CACL;IACD;EACJ;;EAEA;AACJ;AACA;AACA;EACIF,MAAM,CAACD,KAAK,CAAE,GAAEL,cAAe,kBAAiB,EAAE;IAC9C,GAAGQ,eAAe;IAClBG,UAAU;IACVM,IAAI,EAAEC,cAAM,CAACC;EACjB,CAAC,CAAC;EACFf,GAAG,CAACiB,IAAI,CAAC,IAAAI,wBAAW,EAACvB,oBAAoB,EAAEM,eAAe,CAAC,CAAC;AAChE,CAAC;AAAC"}