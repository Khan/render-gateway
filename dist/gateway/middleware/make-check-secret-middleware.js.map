{"version":3,"sources":["../../../src/gateway/middleware/make-check-secret-middleware.js"],"names":["redactSecretHeader","req","headerName","headers","toLowerCase","header","Error","makeProductionMiddleware","options","secretKey","cryptoKeyPath","secrets","secret","res","next","requestSecret","status","send","error","makeDevelopmentMiddleware","Promise","resolve","logger","warn","debug","info","makeCheckSecretMiddleware","authenticationOptions"],"mappings":";;;;;;;AAEA;;AACA;;AACA;;AAIA,MAAMA,kBAAkB,GAAG,CAAeC,GAAf,EAAyBC,UAAzB,KAAgD;AACvE;;;AAGA,SAAOD,GAAG,CAACE,OAAJ,CAAYD,UAAU,CAACE,WAAX,EAAZ,CAAP;AACA;;;;AAGA,MAAIH,GAAG,CAACI,MAAJ,CAAWH,UAAX,KAA0B,IAA9B,EAAoC;AAChC,UAAM,IAAII,KAAJ,CAAU,sCAAV,CAAN;AACH;AACJ,CAXD;;AAaA,eAAeC,wBAAf,CACIC,OADJ,EAEiC;AAC7B;;;;;;;;;AASA,QAAM;AAACC,IAAAA,SAAD;AAAYP,IAAAA,UAAZ;AAAwBQ,IAAAA;AAAxB,MAAyCF,OAA/C;AACA,QAAMG,OAAO,GAAG,MAAM,4BAAWD,aAAX,CAAtB;AACA,QAAME,MAAM,GAAGD,OAAO,CAACF,SAAD,CAAtB;;AACA,MAAIG,MAAM,IAAI,IAAd,EAAoB;AAChB,UAAM,IAAIN,KAAJ,CAAU,uBAAV,CAAN;AACH;;AAED,SAAO,UAAUL,GAAV,EAAoBY,GAApB,EAA8BC,IAA9B,EAAwD;AAC3D,UAAMC,aAAa,GAAGd,GAAG,CAACI,MAAJ,CAAWH,UAAX,CAAtB;AAEA;;;;;;AAKAF,IAAAA,kBAAkB,CAACC,GAAD,EAAMC,UAAN,CAAlB;;AAEA,QAAIa,aAAa,KAAKH,MAAtB,EAA8B;AAC1BC,MAAAA,GAAG,CAACG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAACC,QAAAA,KAAK,EAAE;AAAR,OAArB;AACA;AACH;;AAEDJ,IAAAA,IAAI;AACP,GAhBD;AAiBH;;AAED,SAASK,yBAAT,CACIX,OADJ,EAEiC;AAC7B;;;AAGA,SAAOY,OAAO,CAACC,OAAR,CAAgB,UACnBpB,GADmB,EAEnBY,GAFmB,EAGnBC,IAHmB,EAIf;AACJ,UAAMQ,MAAM,GAAG,uBAAUrB,GAAV,CAAf;AACA;;;;;;;AAMA,QAAIO,OAAO,IAAI,IAAf,EAAqB;AACjB,UAAIP,GAAG,CAACI,MAAJ,CAAWG,OAAO,CAACN,UAAnB,KAAkC,IAAtC,EAA4C;AACxCoB,QAAAA,MAAM,CAACC,IAAP,CACI,oDADJ,EAEI;AACIlB,UAAAA,MAAM,EAAEG,OAAO,CAACN;AADpB,SAFJ;AAMH,OAPD,MAOO;AACH;;;AAGAF,QAAAA,kBAAkB,CAACC,GAAD,EAAMO,OAAO,CAACN,UAAd,CAAlB;AAEAoB,QAAAA,MAAM,CAACE,KAAP,CACI,mEADJ,EAEI;AACInB,UAAAA,MAAM,EAAEG,OAAO,CAACN;AADpB,SAFJ;AAMH;AACJ,KArBD,MAqBO;AACHoB,MAAAA,MAAM,CAACG,IAAP,CAAY,oDAAZ;AACH;;AACDX,IAAAA,IAAI;AACP,GArCM,CAAP;AAsCH;AAED;;;;;;;;;AAOO,SAASY,yBAAT,CACHC,qBADG,EAE0B;AAC7B,MAAIA,qBAAqB,IAAI,IAAzB,IAAiC,iCAAqB,YAA1D,EAAwE;AACpE,WAAOpB,wBAAwB,CAACoB,qBAAD,CAA/B;AACH;;AAED,SAAOR,yBAAyB,CAACQ,qBAAD,CAAhC;AACH","sourcesContent":["// @flow\nimport type {Middleware, $Response, NextFunction} from \"express\";\nimport {getRuntimeMode} from \"../../ka-shared/index.js\";\nimport {getLogger} from \"../../shared/index.js\";\nimport {getSecrets} from \"../get-secrets.js\";\n\nimport type {AuthenticationOptions, Request} from \"../types.js\";\n\nconst redactSecretHeader = <Req: Request>(req: Req, headerName: string) => {\n    /**\n     * We delete the header because we don't want it getting logged.\n     */\n    delete req.headers[headerName.toLowerCase()];\n    /**\n     * Let's make sure that secret is gone.\n     */\n    if (req.header(headerName) != null) {\n        throw new Error(\"Secret header could not be redacted!\");\n    }\n};\n\nasync function makeProductionMiddleware<Req: Request, Res: $Response>(\n    options: AuthenticationOptions,\n): Promise<Middleware<Req, Res>> {\n    /**\n     * We look up the secret when the middleware is created. That means\n     * that if the secret changes, the server needs to be\n     * restarted/refreshed somehow.\n     *\n     * TODO(somewhatabstract, WEB-1410): Add ability to trigger refresh of\n     * server - likely just a killswitch to kill an instance so that GAE spins\n     * up new ones.\n     */\n    const {secretKey, headerName, cryptoKeyPath} = options;\n    const secrets = await getSecrets(cryptoKeyPath);\n    const secret = secrets[secretKey];\n    if (secret == null) {\n        throw new Error(\"Unable to load secret\");\n    }\n\n    return function (req: Req, res: Res, next: NextFunction): void {\n        const requestSecret = req.header(headerName);\n\n        /**\n         * We delete the header because we don't want it getting logged.\n         * However, we need to be aware of the case to make sure we really do\n         * delete it - headers are all lowercase in the express object.\n         */\n        redactSecretHeader(req, headerName);\n\n        if (requestSecret !== secret) {\n            res.status(401).send({error: \"Missing or invalid secret\"});\n            return;\n        }\n\n        next();\n    };\n}\n\nfunction makeDevelopmentMiddleware<Req: Request, Res: $Response>(\n    options: ?AuthenticationOptions,\n): Promise<Middleware<Req, Res>> {\n    /**\n     * The secrets middleware is a noop when not in production.\n     */\n    return Promise.resolve(function (\n        req: Req,\n        res: Res,\n        next: NextFunction,\n    ): void {\n        const logger = getLogger(req);\n        /**\n         * If authentication options were given, let's log a message if the\n         * expected header is omitted. This is a valid thing to do in dev since\n         * we don't authenticate dev requests, but it is also useful to know\n         * during testing if the header is missing.\n         */\n        if (options != null) {\n            if (req.header(options.headerName) == null) {\n                logger.warn(\n                    \"Authentication header was not included in request.\",\n                    {\n                        header: options.headerName,\n                    },\n                );\n            } else {\n                /**\n                 * We delete the header because we don't want it getting logged.\n                 */\n                redactSecretHeader(req, options.headerName);\n\n                logger.debug(\n                    \"Authentication header present but ignored in current runtime mode\",\n                    {\n                        header: options.headerName,\n                    },\n                );\n            }\n        } else {\n            logger.info(\"Authentication is not configured for this service.\");\n        }\n        next();\n    });\n}\n\n/**\n * Make the middleware to verify a request's authentication secret.\n *\n * This is a noop when not in production, otherwise this loads the appropriate\n * secret as identified by the options and then uses the configured header name\n * to identify the request header that it is to be matched against.\n */\nexport function makeCheckSecretMiddleware<Req: Request, Res: $Response>(\n    authenticationOptions?: AuthenticationOptions,\n): Promise<Middleware<Req, Res>> {\n    if (authenticationOptions != null && getRuntimeMode() === \"production\") {\n        return makeProductionMiddleware(authenticationOptions);\n    }\n\n    return makeDevelopmentMiddleware(authenticationOptions);\n}\n"],"file":"make-check-secret-middleware.js"}