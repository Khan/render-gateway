{"version":3,"sources":["../../../../src/gateway/environments/jsdom-sixteen/create-virtual-console.js"],"names":["createVirtualConsole","logger","closed","virtualConsole","VirtualConsole","close","on","e","message","indexOf","simplifiedError","error","kind","Errors","Internal","args","passthruLog","method","silly"],"mappings":";;;;;;;AACA;;AACA;;AACA;;;;;;;;AAKA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,oBAAoB,GAC7BC,MADgC,IAEN;AAC1B,MAAIC,MAAM,GAAG,KAAb;AACA,QAAMC,cAAc,GAAG,IAAIC,qBAAJ,EAAvB,CAF0B,CAI1B;AACA;;AACAD,EAAAA,cAAc,CAACE,KAAf,GAAuB,MAAOH,MAAM,GAAG,IAAvC;;AAEAC,EAAAA,cAAc,CAACG,EAAf,CAAkB,YAAlB,EAAiCC,CAAD,IAAc;AAC1C,QAAIL,MAAJ,EAAY;AACR;AACA;AACH;;AACD,QAAIK,CAAC,CAACC,OAAF,CAAUC,OAAV,CAAkB,oBAAlB,KAA2C,CAA/C,EAAkD;AAC9C;AACA;AACA;AACH;;AACD,UAAMC,eAAe,GAAG,yBAAaH,CAAb,CAAxB;AACAN,IAAAA,MAAM,CAACU,KAAP,CAAc,oBAAmBD,eAAe,CAACC,KAAhB,IAAyB,EAAG,EAA7D,kCACOD,eADP;AAEIE,MAAAA,IAAI,EAAEC,eAAOC;AAFjB;AAIH,GAfD;AAiBA;AACJ;AACA;AACA;AACA;AACA;;AACIX,EAAAA,cAAc,CAACG,EAAf,CACI,OADJ,EAEI,CAACE,OAAD,EAAU,GAAGO,IAAb,KACI,CAACb,MAAD,IAAWD,MAAM,CAACU,KAAP,CAAc,eAAcH,OAAQ,EAApC,EAAuC;AAACO,IAAAA;AAAD,GAAvC,CAHnB;AAMA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;;AACI,QAAMC,WAAW,GAAIC,MAAD,IAA+C;AAC/D,KAACf,MAAD,IACIC,cAAc,CAACG,EAAf,CAAkBW,MAAlB,EAA0B,CAACT,OAAD,EAAU,GAAGO,IAAb,KACtBd,MAAM,CAACiB,KAAP,CAAc,SAAQD,MAAO,IAAGT,OAAQ,EAAxC,EAA2C;AAACO,MAAAA;AAAD,KAA3C,CADJ,CADJ;AAIH,GALD;;AAMAC,EAAAA,WAAW,CAAC,MAAD,CAAX;AACAA,EAAAA,WAAW,CAAC,MAAD,CAAX;AACAA,EAAAA,WAAW,CAAC,KAAD,CAAX;AACAA,EAAAA,WAAW,CAAC,OAAD,CAAX,CAtD0B,CAwD1B;;AACA,SAAQb,cAAR;AACH,CA5DM","sourcesContent":["// @flow\nimport {VirtualConsole} from \"jsdom\";\nimport {extractError} from \"../../../shared/index.js\";\nimport {Errors} from \"../../../ka-shared/index.js\";\nimport type {Logger, ICloseable} from \"../../../shared/index.js\";\n\ntype CloseableVirtualConsole = ICloseable & typeof VirtualConsole;\n\n/**\n * Create a virtual console for use with JSDOM.\n *\n * @param {Logger} logger The logger to which this virtual console logs.\n * @returns {VirtualConsole} A JSDOM VirtualConsole instance.\n */\nexport const createVirtualConsole = (\n    logger: Logger,\n): CloseableVirtualConsole => {\n    let closed = false;\n    const virtualConsole = new VirtualConsole();\n\n    // We know virtual console doesn't have a close. We're adding it.\n    // $FlowIgnore[prop-missing]\n    virtualConsole.close = () => (closed = true);\n\n    virtualConsole.on(\"jsdomError\", (e: Error) => {\n        if (closed) {\n            // We are closed. No logging.\n            return;\n        }\n        if (e.message.indexOf(\"Could not load img\") >= 0) {\n            // We know that images cannot load. We're deliberately blocking\n            // them.\n            return;\n        }\n        const simplifiedError = extractError(e);\n        logger.error(`JSDOM jsdomError:${simplifiedError.error || \"\"}`, {\n            ...simplifiedError,\n            kind: Errors.Internal,\n        });\n    });\n\n    /**\n     * NOTE(somewhatabstract): We pass args array as the metadata parameter for\n     * winston log. We don't worry about adding the error kind here; we mark\n     * these as Errors.Internal automatically if they don't already include a\n     * kind.\n     */\n    virtualConsole.on(\n        \"error\",\n        (message, ...args) =>\n            !closed && logger.error(`JSDOM error:${message}`, {args}),\n    );\n\n    /**\n     * We log all other things as `silly`, since they are generally only useful\n     * to us when we're developing/debugging issues locally, and not in\n     * production. We could add some way to turn this on in production\n     * temporarily (like a temporary \"elevate log level\" query param) if\n     * we find that will be useful, but I haven't encountered an issue that\n     * needed these in production yet; they're just noise.\n     */\n    const passthruLog = (method: \"warn\" | \"info\" | \"log\" | \"debug\") => {\n        !closed &&\n            virtualConsole.on(method, (message, ...args) =>\n                logger.silly(`JSDOM ${method}:${message}`, {args}),\n            );\n    };\n    passthruLog(\"warn\");\n    passthruLog(\"info\");\n    passthruLog(\"log\");\n    passthruLog(\"debug\");\n\n    // We have made this into a real closeable virtual console.\n    return (virtualConsole: any);\n};\n"],"file":"create-virtual-console.js"}