{"version":3,"file":"jsdom-sixteen-file-resource-loader.js","names":["readFileAsync","fs","readFile","JSDOMSixteenFileResourceLoader","ResourceLoader","constructor","rootFolder","url","path","isAbsolute","parsedURL","URL","normalize","join","_rootFolder","pathname","e","existsSync","KAError","Errors","NotFound","fetch","options","filePath","_makeFilePath"],"sources":["../../../../src/gateway/environments/jsdom-sixteen/jsdom-sixteen-file-resource-loader.js"],"sourcesContent":["// @flow\nimport fs from \"fs\";\nimport path from \"path\";\nimport {promisify} from \"util\";\nimport {ResourceLoader} from \"jsdom\";\nimport type {FetchOptions} from \"jsdom\";\nimport {KAError} from \"../../../shared/index.js\";\nimport {Errors} from \"../../../ka-shared/index.js\";\nimport {applyAbortablePromisesPatch} from \"./apply-abortable-promises-patch.js\";\n\nconst readFileAsync = promisify(fs.readFile);\n\n/**\n * A ResourceLoader implementation for JSDOM sixteen-compatible versions of\n * JSDOM that loads files from disk.\n */\nexport class JSDOMSixteenFileResourceLoader extends ResourceLoader {\n    _rootFolder: string;\n\n    /**\n     * Create instance of the resource loader.\n     *\n     * @param {string} rootFolder\n     * The root of where we will load files.\n     */\n    constructor(rootFolder: string) {\n        // Patch before super to make sure promises get an abort.\n        applyAbortablePromisesPatch();\n\n        super();\n\n        if (!fs.existsSync(rootFolder)) {\n            throw new KAError(\"Root folder cannot be found\", Errors.NotFound);\n        }\n\n        this._rootFolder = rootFolder;\n    }\n\n    _makeFilePath: (string) => string = (url) => {\n        /**\n         * If the url is a url, we are going to use it as a file path from root.\n         *\n         * If it is an absolute path, we just use it, otherwise we treat it\n         * as a relative path from root.\n         */\n        if (path.isAbsolute(url)) {\n            return url;\n        }\n\n        try {\n            const parsedURL = new URL(url);\n            return path.normalize(\n                path.join(this._rootFolder, parsedURL.pathname),\n            );\n        } catch (e) {\n            /* nothing */\n        }\n\n        // Assume relative path\n        return path.normalize(path.join(this._rootFolder, url));\n    };\n\n    fetch(url: string, options?: FetchOptions): ?Promise<Buffer> {\n        const filePath = this._makeFilePath(url);\n        return readFileAsync(filePath);\n    }\n}\n"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;;;;;AAEA,MAAMA,aAAa,GAAG,qBAAUC,YAAGC,QAAb,CAAtB;AAEA;AACA;AACA;AACA;;AACO,MAAMC,8BAAN,SAA6CC,qBAA7C,CAA4D;EAG/D;AACJ;AACA;AACA;AACA;AACA;EACIC,WAAW,CAACC,UAAD,EAAqB;IAC5B;IACA;IAEA;;IAJ4B;;IAAA,uCAaKC,GAAD,IAAS;MACzC;AACR;AACA;AACA;AACA;AACA;MACQ,IAAIC,cAAKC,UAAL,CAAgBF,GAAhB,CAAJ,EAA0B;QACtB,OAAOA,GAAP;MACH;;MAED,IAAI;QACA,MAAMG,SAAS,GAAG,IAAIC,GAAJ,CAAQJ,GAAR,CAAlB;QACA,OAAOC,cAAKI,SAAL,CACHJ,cAAKK,IAAL,CAAU,KAAKC,WAAf,EAA4BJ,SAAS,CAACK,QAAtC,CADG,CAAP;MAGH,CALD,CAKE,OAAOC,CAAP,EAAU;QACR;MACH,CAlBwC,CAoBzC;;;MACA,OAAOR,cAAKI,SAAL,CAAeJ,cAAKK,IAAL,CAAU,KAAKC,WAAf,EAA4BP,GAA5B,CAAf,CAAP;IACH,CAnC+B;;IAM5B,IAAI,CAACN,YAAGgB,UAAH,CAAcX,UAAd,CAAL,EAAgC;MAC5B,MAAM,IAAIY,cAAJ,CAAY,6BAAZ,EAA2CC,eAAOC,QAAlD,CAAN;IACH;;IAED,KAAKN,WAAL,GAAmBR,UAAnB;EACH;;EA0BDe,KAAK,CAACd,GAAD,EAAce,OAAd,EAAwD;IACzD,MAAMC,QAAQ,GAAG,KAAKC,aAAL,CAAmBjB,GAAnB,CAAjB;;IACA,OAAOP,aAAa,CAACuB,QAAD,CAApB;EACH;;AAjD8D"}