{"version":3,"sources":["../../../../src/gateway/environments/jsdom-sixteen/jsdom-sixteen-resource-loader.js"],"names":["JSDOMSixteenResourceLoader","ResourceLoader","EMPTY_RESPONSE","Promise","resolve","Buffer","from","constructor","renderAPI","requestOptions","DefaultRequestOptions","Error","_active","_renderAPI","_requestOptions","isActive","close","fetch","url","options","logger","isInlineData","startsWith","readableURLForLogging","warn","JSFileRegex","test","silly","abortableFetch","agent","URL","handleInactive","then","response","text","abort"],"mappings":";;;;;;;AACA;;AACA;;AAGA;;AACA;;AAKA;;;;;;;;AAEA;;;;;;;AAOO,MAAMA,0BAAN,SAAyCC,qBAAzC,CAAwD;AAC3D;;;;AAQA,aAAWC,cAAX,GAA6C;AACzC,WAAOC,OAAO,CAACC,OAAR,CAAgBC,MAAM,CAACC,IAAP,CAAY,EAAZ,CAAhB,CAAP;AACH;AAED;;;;;;;;AAMAC,EAAAA,WAAW,CACPC,SADO,EAEPC,cAA+B,GAAGC,8BAF3B,EAGT;AACE;AACA;AAEA;;AAJF;;AAAA;;AAAA;;AAME,QAAIF,SAAS,IAAI,IAAjB,EAAuB;AACnB,YAAM,IAAIG,KAAJ,CAAU,0BAAV,CAAN;AACH;;AAED,SAAKC,OAAL,GAAe,IAAf;AACA,SAAKC,UAAL,GAAkBL,SAAlB;AACA,SAAKM,eAAL,GAAuBL,cAAvB;AACH;;AAED,MAAIM,QAAJ,GAAwB;AACpB,WAAO,KAAKH,OAAZ;AACH;;AAEDI,EAAAA,KAAK,GAAS;AACV,SAAKJ,OAAL,GAAe,KAAf;AACA;AACH;;AAEDK,EAAAA,KAAK,CAACC,GAAD,EAAcC,OAAd,EAAwD;AACzD,UAAMC,MAAM,GAAG,KAAKP,UAAL,CAAgBO,MAA/B;AACA,UAAMC,YAAY,GAAGH,GAAG,CAACI,UAAJ,CAAe,OAAf,CAArB;AACA,UAAMC,qBAAqB,GAAGF,YAAY,GAAG,aAAH,GAAmBH,GAA7D;;AACA,QAAI,CAAC,KAAKN,OAAV,EAAmB;AACf;;;;;;;;AAQA,UAAI,CAACS,YAAL,EAAmB;AACfD,QAAAA,MAAM,CAACI,IAAP,CACK,qDAAoDD,qBAAsB,EAD/E;AAGH;AAED;;;;;;;;AAMA,aAAOvB,0BAA0B,CAACE,cAAlC;AACH;AAED;;;;;;;AAKA,UAAMuB,WAAW,GAAG,mBAApB;;AACA,QAAI,CAACA,WAAW,CAACC,IAAZ,CAAiBR,GAAjB,CAAL,EAA4B;AACxBE,MAAAA,MAAM,CAACO,KAAP,CAAc,UAASJ,qBAAsB,EAA7C;AAEA;;;;;;;AAMA,aAAOvB,0BAA0B,CAACE,cAAlC;AACH;AAED;;;;;;AAIA,UAAM0B,cAAc,GAAG,sBAAQR,MAAR,EAAgBF,GAAhB,kCAChB,KAAKJ,eADW;AAEnBe,MAAAA,KAAK,EAAE,2BAAe,IAAIC,QAAJ,CAAQZ,GAAR,CAAf;AAFY,OAAvB;AAIA,UAAMa,cAAc,GAAGH,cAAc,CAACI,IAAf,CAAqBC,QAAD,IAAc;AACrD,UAAI,CAAC,KAAKrB,OAAV,EAAmB;AACfQ,QAAAA,MAAM,CAACO,KAAP,CACK,kCAAiCJ,qBAAsB,EAD5D;AAIA;;;;;;AAKA,eAAOlB,MAAM,CAACC,IAAP,CAAY,EAAZ,CAAP;AACH;;AACD,aAAOD,MAAM,CAACC,IAAP,CAAY2B,QAAQ,CAACC,IAArB,CAAP;AACH,KAdsB,CAAvB;AAgBA;;;;;AAICH,IAAAA,cAAD,CAAsBI,KAAtB,GAA8BP,cAAc,CAACO,KAA7C;AACA,WAAOJ,cAAP;AACH;;AA1H0D","sourcesContent":["// @flow\nimport {URL} from \"url\";\nimport {ResourceLoader} from \"jsdom\";\nimport type {FetchOptions} from \"jsdom\";\nimport type {RequestOptions, RenderAPI} from \"../../types.js\";\nimport {getAgentForURL} from \"../../../shared/index.js\";\nimport {\n    DefaultRequestOptions,\n    request,\n    abortInFlightRequests,\n} from \"../../request.js\";\nimport {applyAbortablePromisesPatch} from \"./apply-abortable-promises-patch.js\";\n\n/**\n * A ResourceLoader implementation for JSDOM sixteen-compatible versions of\n * JSDOM that only allows for fetching JS files.\n *\n * A JS file request is identified by the regular expression:\n *   /^.*\\.js(?:\\?.*)?/g\n */\nexport class JSDOMSixteenResourceLoader extends ResourceLoader {\n    /**\n     * Used to indicate if any pending requests are still needed so that we\n     * can report when an unused request is fulfilled.\n     */\n    _active: boolean;\n    _renderAPI: RenderAPI;\n    _requestOptions: RequestOptions;\n\n    static get EMPTY_RESPONSE(): Promise<Buffer> {\n        return Promise.resolve(Buffer.from(\"\"));\n    }\n\n    /**\n     * Create instance of the resource loader.\n     *\n     * @param {RequestFn} requestFn\n     * The function responsibly for fulfilling GET requests for URLs.\n     */\n    constructor(\n        renderAPI: RenderAPI,\n        requestOptions?: RequestOptions = DefaultRequestOptions,\n    ) {\n        // Patch before super to make sure promises get an abort.\n        applyAbortablePromisesPatch();\n\n        super();\n\n        if (renderAPI == null) {\n            throw new Error(\"Must provide render API.\");\n        }\n\n        this._active = true;\n        this._renderAPI = renderAPI;\n        this._requestOptions = requestOptions;\n    }\n\n    get isActive(): boolean {\n        return this._active;\n    }\n\n    close(): void {\n        this._active = false;\n        abortInFlightRequests();\n    }\n\n    fetch(url: string, options?: FetchOptions): ?Promise<Buffer> {\n        const logger = this._renderAPI.logger;\n        const isInlineData = url.startsWith(\"data:\");\n        const readableURLForLogging = isInlineData ? \"inline data\" : url;\n        if (!this._active) {\n            /**\n             * If we get here, then something is trying to fetch when our\n             * environment has closed us down. This could be in the reject\n             * or resolve of a promise, for example.\n             *\n             * If it's inlinedata, it really doesn't matter, so let's log it\n             * only if it's for a file.\n             */\n            if (!isInlineData) {\n                logger.warn(\n                    `File fetch attempted after resource loader close: ${readableURLForLogging}`,\n                );\n            }\n\n            /**\n             * Though we intentionally don't want to load this file, we can't\n             * just return null per the spec as this can break promise\n             * resolutions that are relying on this file. Instead, we resolve\n             * as an empty string so things can tidy up properly.\n             */\n            return JSDOMSixteenResourceLoader.EMPTY_RESPONSE;\n        }\n\n        /**\n         * We must still be active.\n         * If this request is not a JavaScript file, we are going to return an\n         * empty response as we don't care about non-JS resources.\n         */\n        const JSFileRegex = /^.*\\.js(?:\\?.*)?/g;\n        if (!JSFileRegex.test(url)) {\n            logger.silly(`EMPTY: ${readableURLForLogging}`);\n\n            /**\n             * Though we intentionally don't want to load this file, we can't\n             * just return null per the spec as this can break promise\n             * resolutions that are relying on this file. Instead, we resolve\n             * as an empty string so things can tidy up properly.\n             */\n            return JSDOMSixteenResourceLoader.EMPTY_RESPONSE;\n        }\n\n        /**\n         * This must be a JavaScript file request. Let's make a request for the\n         * file and then handle it coming back.\n         */\n        const abortableFetch = request(logger, url, {\n            ...this._requestOptions,\n            agent: getAgentForURL(new URL(url)),\n        });\n        const handleInactive = abortableFetch.then((response) => {\n            if (!this._active) {\n                logger.silly(\n                    `File requested but never used: ${readableURLForLogging}`,\n                );\n\n                /**\n                 * Just return an empty buffer so no code executes. The\n                 * request function passed at construction will have handled\n                 * caching of the real file request.\n                 */\n                return Buffer.from(\"\");\n            }\n            return Buffer.from(response.text);\n        });\n\n        /**\n         * We have to turn this back into an abortable promise so that JSDOM\n         * can abort it when closing, if it needs to.\n         */\n        (handleInactive: any).abort = abortableFetch.abort;\n        return handleInactive;\n    }\n}\n"],"file":"jsdom-sixteen-resource-loader.js"}