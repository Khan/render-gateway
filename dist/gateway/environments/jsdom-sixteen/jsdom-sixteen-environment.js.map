{"version":3,"sources":["../../../../src/gateway/environments/jsdom-sixteen/jsdom-sixteen-environment.js"],"names":["MinimalPage","JSDOMSixteenEnvironment","constructor","configuration","url","renderAPI","resourceLoader","traceSession","trace","fileURLs","_configuration","getFileList","options","fetch","addLabel","length","files","Promise","all","map","f","fetchResult","KAError","Errors","TransientService","then","b","content","toString","urls","end","closeables","getResourceLoader","push","_retrieveTargetFiles","JSDOM","require","createVirtualConsole","jsdomInstance","runScripts","resources","pretendToBeVisual","virtualConsole","logger","window","vmContext","getInternalVMContext","tmpFnName","patchAgainstDanglingTimers","timerGateAPI","_runScript","afterRenderTidyUp","afterEnvSetup","registrationCallbackName","registeredCbName","cb","close","filename","Internal","result","Object","prototype","hasOwnProperty","call","JSON","stringify","_closeAll","resolve","setTimeout","i","e","simplifiedError","error","kind","script","Script","realScript","runInContext"],"mappings":"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","sourcesContent":["// @flow\nimport {extractError, KAError} from \"../../../shared/index.js\";\nimport {Errors} from \"../../../ka-shared/index.js\";\nimport type {Logger, ITraceSession} from \"../../../shared/index.js\";\nimport type {\n    IJSDOMSixteenConfiguration,\n    CloseableResourceLoader,\n    IGate,\n    ICloseable,\n} from \"./types.js\";\nimport type {IRenderEnvironment, RenderAPI, RenderResult} from \"../../types.js\";\n\ninterface RenderCallbackFn {\n    /**\n     * Method invoked to create a render result.\n     */\n    (): Promise<RenderResult>;\n}\n\n/**\n * A JS file.\n */\ntype JavaScriptFile = {\n    /**\n     * The content of the file.\n     */\n    +content: string,\n\n    /**\n     * The URL of the file.\n     */\n    +url: string,\n};\n\ntype JavaScriptFiles = {\n    +files: $ReadOnlyArray<JavaScriptFile>,\n    +urls: $ReadOnlyArray<string>,\n};\n\nconst MinimalPage = \"<!DOCTYPE html><html><head></head><body></body></html>\";\n\n/**\n * A render environment built to support the JSDOM 16.x API.\n */\nexport class JSDOMSixteenEnvironment implements IRenderEnvironment {\n    _configuration: IJSDOMSixteenConfiguration;\n\n    /**\n     * Create a new instance of this environment.\n     *\n     * @param {IJSDOMSixteenConfiguration} configuration\n     * Configuration for the environment.\n     */\n    constructor(configuration: IJSDOMSixteenConfiguration) {\n        if (configuration == null) {\n            throw new KAError(\n                \"Must provide environment configuration\",\n                Errors.Internal,\n            );\n        }\n        this._configuration = configuration;\n    }\n\n    _retrieveTargetFiles: (\n        url: string,\n        renderAPI: RenderAPI,\n        resourceLoader: CloseableResourceLoader,\n    ) => Promise<JavaScriptFiles> = async (\n        url: string,\n        renderAPI: RenderAPI,\n        resourceLoader: CloseableResourceLoader,\n    ): Promise<JavaScriptFiles> => {\n        const traceSession: ITraceSession = renderAPI.trace(\n            \"JSDOM16._retrieveTargetFiles\",\n            `JSDOMSixteenEnvironment retrieving files`,\n        );\n        try {\n            /**\n             * First, we need to know what files to execute so that we can\n             * produce a render result, and we need a resource loader so that\n             * we can retrieve those files as well as support retrieving\n             * additional files within our JSDOM environment.\n             */\n            const fileURLs = await this._configuration.getFileList(\n                url,\n                renderAPI,\n                (url, options) => resourceLoader.fetch(url, options),\n            );\n            traceSession.addLabel(\"fileCount\", fileURLs.length);\n\n            /**\n             * Now let's use the resource loader to get the files.\n             * We ignore the `FetchOptions` param of resourceLoader.fetch as we\n             * have nothing to pass there.\n             */\n            return {\n                files: await Promise.all(\n                    fileURLs.map((f) => {\n                        const fetchResult = resourceLoader.fetch(f);\n                        /**\n                         * Resource loader's fetch can return null. It shouldn't for\n                         * any of these files though, so if it does, let's raise an\n                         * error!\n                         */\n                        if (fetchResult == null) {\n                            throw new KAError(\n                                `Unable to retrieve ${f}. ResourceLoader returned null.`,\n                                Errors.TransientService,\n                            );\n                        }\n                        /**\n                         * No need to reconnect the abort() in this case since we\n                         * won't be calling it.\n                         */\n                        return fetchResult.then((b) => ({\n                            content: b.toString(),\n                            url: f,\n                        }));\n                    }),\n                ),\n                urls: fileURLs,\n            };\n        } finally {\n            traceSession.end();\n        }\n    };\n\n    _closeAll(closeables: Array<ICloseable>, logger: Logger): Promise<void> {\n        return new Promise((resolve) => {\n            /**\n             * We wrap this in a timeout to hopefully mitigate any chances\n             * of https://github.com/jsdom/jsdom/issues/1682\n             */\n            setTimeout(() => {\n                /**\n                 * We want to close things in reverse, just to be sure we\n                 * tidy up in the same order that we put things together.\n                 */\n                for (let i = closeables.length - 1; i >= 0; i--) {\n                    try {\n                        closeables[i]?.close?.();\n                    } catch (e) {\n                        const simplifiedError = extractError(e);\n                        logger.error(\n                            `Closeable encountered an error: ${\n                                simplifiedError.error || \"\"\n                            }`,\n                            {\n                                ...simplifiedError,\n                                kind: Errors.Internal,\n                            },\n                        );\n                    }\n                }\n                /**\n                 * Let's clear the array to make sure we're not holding\n                 * on to any references unnecessarily.\n                 */\n                closeables.length = 0;\n                resolve();\n            });\n        });\n    }\n\n    _runScript(\n        vmContext: vm$Context,\n        script: string,\n        options?: vm$ScriptOptions,\n    ): any {\n        const {Script} = require(\"vm\");\n        const realScript = new Script(script, options);\n        return realScript.runInContext(vmContext);\n    }\n\n    /**\n     * Generate a render result for the given url.\n     *\n     * @param {string} url The URL that is to be rendered. This is always\n     * relative to the host and so does not contain protocol, hostname, nor port\n     * information.\n     * @param {RenderAPI} renderAPI An API of utilities for assisting with the\n     * render operation.\n     * @returns {Promise<RenderResult>} The result of the render that is to be\n     * returned by the gateway service as the response to the render request.\n     * This includes the body of the response and the status code information.\n     */\n    render: (\n        url: string,\n        renderAPI: RenderAPI,\n    ) => Promise<RenderResult> = async (\n        url: string,\n        renderAPI: RenderAPI,\n    ): Promise<RenderResult> => {\n        /**\n         * We want to tidy up nicely if there's a problem and also if the render\n         * context is closed, so let's handle that by putting closeable things\n         * into a handy list and providing a way to close them all.\n         */\n        const closeables: Array<ICloseable> = [];\n        try {\n            /**\n             * We are going to need a resource loader so that we can obtain files\n             * both inside and outside the JSDOM VM.\n             */\n            const resourceLoader = this._configuration.getResourceLoader(\n                url,\n                renderAPI,\n            );\n            closeables.push(resourceLoader);\n\n            // Let's get those files!\n            const files = await this._retrieveTargetFiles(\n                url,\n                renderAPI,\n                resourceLoader,\n            );\n\n            /**\n             * We want a JSDOM instance for the url we want to render. This is\n             * where we setup custom resource loading and our virtual console\n             * too.\n             */\n            const {JSDOM} = require(\"jsdom\");\n            const {\n                createVirtualConsole,\n            } = require(\"./create-virtual-console.js\");\n            const jsdomInstance = new JSDOM(MinimalPage, {\n                url,\n                runScripts: \"dangerously\",\n                resources: (resourceLoader: any),\n                pretendToBeVisual: true,\n                virtualConsole: createVirtualConsole(renderAPI.logger),\n            });\n            closeables.push(jsdomInstance.window);\n\n            /**\n             * OK, we know this is a JSDOM instance but we want to expose a nice\n             * wrapper. As part of that wrapper, we want to make it easier to\n             * run scripts (like our rendering JS code) within the VM context.\n             * So, let's create a helper for that.\n             *\n             * We cast the context to any, because otherwise it is typed as an\n             * empty object, which makes life annoying.\n             */\n            const vmContext: any = jsdomInstance.getInternalVMContext();\n\n            /**\n             * Next, we want to patch timers so we can make sure they don't\n             * fire after we are done (and so we can catch dangling timers if\n             * necessary). To do this, we are going to hang the timer API off\n             * the vmContext and then execute it from inside the context.\n             * Super magic.\n             */\n            const tmpFnName = \"__tmp_patchTimers\";\n            const {\n                patchAgainstDanglingTimers,\n            } = require(\"./patch-against-dangling-timers.js\");\n            vmContext[tmpFnName] = patchAgainstDanglingTimers;\n            const timerGateAPI: IGate = this._runScript(\n                vmContext,\n                `${tmpFnName}(window);`,\n            );\n            delete vmContext[tmpFnName];\n            closeables.push(timerGateAPI);\n\n            /**\n             * At this point, we give our configuration an opportunity to\n             * modify the render context and capture the return result, which\n             * can be used to tidy up after we're done.\n             */\n            const afterRenderTidyUp = await this._configuration.afterEnvSetup(\n                url,\n                files.urls,\n                renderAPI,\n                vmContext,\n            );\n            closeables.push(afterRenderTidyUp);\n\n            /**\n             * At this point, before loading the files for rendering, we must\n             * configure the registration point in our render context.\n             */\n            const {registrationCallbackName} = this._configuration;\n            const registeredCbName = \"__registeredCallback\";\n            vmContext[registrationCallbackName] = (\n                cb: RenderCallbackFn,\n            ): void => {\n                vmContext[registrationCallbackName][registeredCbName] = cb;\n            };\n            closeables.push({\n                close: () => {\n                    delete vmContext[registrationCallbackName];\n                },\n            });\n\n            /**\n             * The context is configured. Now we need to load the files into it\n             * which should cause our registration callback to be invoked.\n             * We pass the filename here so we can get some nicer stack traces.\n             */\n            for (const {content, url} of files.files) {\n                this._runScript(vmContext, content, {filename: url});\n            }\n\n            /**\n             * With the files all loaded, we should have a registered callback.\n             * Let's assert that and then invoke the render process.\n             */\n            if (\n                typeof vmContext[registrationCallbackName][registeredCbName] !==\n                \"function\"\n            ) {\n                throw new KAError(\n                    \"No render callback was registered.\",\n                    Errors.Internal,\n                );\n            }\n\n            /**\n             * And now we run the registered callback inside the VM.\n             */\n            const result: RenderResult = await this._runScript(\n                vmContext,\n                `\n    const cb = window[\"${registrationCallbackName}\"][\"${registeredCbName}\"];\n    cb();`,\n            );\n\n            /**\n             * Let's make sure that the rendered function returned something\n             * resembling a render result.\n             */\n            if (\n                result == null ||\n                !Object.prototype.hasOwnProperty.call(result, \"body\") ||\n                !Object.prototype.hasOwnProperty.call(result, \"status\") ||\n                !Object.prototype.hasOwnProperty.call(result, \"headers\")\n            ) {\n                throw new KAError(\n                    `Malformed render result: ${JSON.stringify(result)}`,\n                    Errors.Internal,\n                );\n            }\n\n            /**\n             * After all that, we should have a result, so let's return it and\n             * let our finally tidy up all the render context we built.\n             */\n            return result;\n        } finally {\n            /**\n             * We need to make sure that whatever happens, we tidy everything\n             * up.\n             */\n            await this._closeAll(closeables, renderAPI.logger);\n        }\n    };\n}\n"],"file":"jsdom-sixteen-environment.js"}