{"version":3,"file":"jsdom-sixteen-environment.js","names":["MinimalPage","JSDOMSixteenEnvironment","constructor","configuration","url","renderAPI","resourceLoader","traceSession","trace","fileURLs","_configuration","getFileList","fetch","addLabel","length","files","Promise","all","map","f","fetchResult","KAError","Errors","TransientService","then","b","content","toString","urls","end","closeables","getResourceLoader","push","_retrieveTargetFiles","JSDOM","require","CloseableVirtualConsole","virtualConsole","logger","jsdomInstance","runScripts","resources","pretendToBeVisual","window","vmContext","getInternalVMContext","tmpFnName","patchAgainstDanglingTimers","timerGateAPI","_runScript","afterRenderTidyUp","afterEnvSetup","registrationCallbackName","registeredCbName","cb","close","filename","Internal","result","safeHasOwnProperty","JSON","stringify","_closeAll","resolve","setTimeout","reportCloseableError","e","simplifiedError","extractError","error","kind","c","catch","script","options","Script","realScript","runInContext"],"sources":["../../../../src/gateway/environments/jsdom-sixteen/jsdom-sixteen-environment.js"],"sourcesContent":["// @flow\nimport {\n    extractError,\n    KAError,\n    safeHasOwnProperty,\n} from \"../../../shared/index.js\";\nimport {Errors} from \"../../../ka-shared/index.js\";\nimport type {\n    Logger,\n    ITraceSession,\n    ICloseable,\n    AmbiguousError,\n} from \"../../../shared/index.js\";\nimport type {\n    IJSDOMSixteenConfiguration,\n    CloseableResourceLoader,\n    IGate,\n} from \"./types.js\";\nimport type {IRenderEnvironment, RenderAPI, RenderResult} from \"../../types.js\";\n\ninterface RenderCallbackFn {\n    /**\n     * Method invoked to create a render result.\n     */\n    (): Promise<RenderResult>;\n}\n\n/**\n * A JS file.\n */\ntype JavaScriptFile = {\n    /**\n     * The content of the file.\n     */\n    +content: string,\n\n    /**\n     * The URL of the file.\n     */\n    +url: string,\n};\n\ntype JavaScriptFiles = {\n    +files: $ReadOnlyArray<JavaScriptFile>,\n    +urls: $ReadOnlyArray<string>,\n};\n\nconst MinimalPage = \"<!DOCTYPE html><html><head></head><body></body></html>\";\n\n/**\n * A render environment built to support the JSDOM 16.x API.\n */\nexport class JSDOMSixteenEnvironment implements IRenderEnvironment {\n    _configuration: IJSDOMSixteenConfiguration;\n\n    /**\n     * Create a new instance of this environment.\n     *\n     * @param {IJSDOMSixteenConfiguration} configuration\n     * Configuration for the environment.\n     */\n    constructor(configuration: IJSDOMSixteenConfiguration) {\n        if (configuration == null) {\n            throw new KAError(\n                \"Must provide environment configuration\",\n                Errors.Internal,\n            );\n        }\n        this._configuration = configuration;\n    }\n\n    _retrieveTargetFiles: (\n        url: string,\n        renderAPI: RenderAPI,\n        resourceLoader: CloseableResourceLoader,\n    ) => Promise<JavaScriptFiles> = async (\n        url: string,\n        renderAPI: RenderAPI,\n        resourceLoader: CloseableResourceLoader,\n    ): Promise<JavaScriptFiles> => {\n        const traceSession: ITraceSession = renderAPI.trace(\n            \"JSDOM16._retrieveTargetFiles\",\n            `JSDOMSixteenEnvironment retrieving files`,\n        );\n        try {\n            /**\n             * First, we need to know what files to execute so that we can\n             * produce a render result, and we need a resource loader so that\n             * we can retrieve those files as well as support retrieving\n             * additional files within our JSDOM environment.\n             */\n            const fileURLs = await this._configuration.getFileList(\n                url,\n                renderAPI,\n                (url) => resourceLoader.fetch(url),\n            );\n            traceSession.addLabel(\"fileCount\", fileURLs.length);\n\n            /**\n             * Now let's use the resource loader to get the files.\n             * We ignore the `FetchOptions` param of resourceLoader.fetch as we\n             * have nothing to pass there.\n             */\n            return {\n                files: await Promise.all(\n                    fileURLs.map((f) => {\n                        const fetchResult = resourceLoader.fetch(f);\n                        /**\n                         * Resource loader's fetch can return null. It shouldn't for\n                         * any of these files though, so if it does, let's raise an\n                         * error!\n                         */\n                        if (fetchResult == null) {\n                            throw new KAError(\n                                `Unable to retrieve ${f}. ResourceLoader returned null.`,\n                                Errors.TransientService,\n                            );\n                        }\n                        /**\n                         * No need to reconnect the abort() in this case since we\n                         * won't be calling it.\n                         */\n                        return fetchResult.then((b) => ({\n                            content: b.toString(),\n                            url: f,\n                        }));\n                    }),\n                ),\n                urls: fileURLs,\n            };\n        } finally {\n            traceSession.end();\n        }\n    };\n\n    _closeAll(closeables: Array<?ICloseable>, logger: Logger): Promise<void> {\n        return new Promise((resolve) => {\n            /**\n             * We wrap this in a timeout to hopefully mitigate any chances\n             * of https://github.com/jsdom/jsdom/issues/1682\n             */\n            setTimeout(async () => {\n                const reportCloseableError = (e: AmbiguousError) => {\n                    // We do not want to stop closing just because something\n                    // errored.\n                    const simplifiedError = extractError(e);\n                    logger.error(\n                        `Closeable encountered an error: ${\n                            simplifiedError.error || \"\"\n                        }`,\n                        {\n                            ...simplifiedError,\n                            kind: Errors.Internal,\n                        },\n                    );\n                };\n                /**\n                 * We want to close things. We're going to assume that\n                 * things are robust to change and close everything at once.\n                 * That way we shutdown as fast as we can, and any \"closed\"\n                 * states that are set on close to gate things like wasted\n                 * JS requests are properly entered as soon as possible.\n                 */\n                await Promise.all(\n                    closeables.map((c) => {\n                        try {\n                            return c?.close?.()?.catch(reportCloseableError);\n                        } catch (e) {\n                            reportCloseableError(e);\n                        }\n                    }),\n                );\n\n                /**\n                 * Let's clear the array to make sure we're not holding\n                 * on to any references unnecessarily.\n                 */\n                closeables.length = 0;\n                resolve();\n            });\n        });\n    }\n\n    _runScript(\n        vmContext: vm$Context,\n        script: string,\n        options?: vm$ScriptOptions,\n    ): any {\n        const {Script} = require(\"vm\");\n        const realScript = new Script(script, options);\n        return realScript.runInContext(vmContext);\n    }\n\n    /**\n     * Generate a render result for the given url.\n     *\n     * @param {string} url The URL that is to be rendered. This is always\n     * relative to the host and so does not contain protocol, hostname, nor port\n     * information.\n     * @param {RenderAPI} renderAPI An API of utilities for assisting with the\n     * render operation.\n     * @returns {Promise<RenderResult>} The result of the render that is to be\n     * returned by the gateway service as the response to the render request.\n     * This includes the body of the response and the status code information.\n     */\n    render: (url: string, renderAPI: RenderAPI) => Promise<RenderResult> =\n        async (url: string, renderAPI: RenderAPI): Promise<RenderResult> => {\n            /**\n             * We want to tidy up nicely if there's a problem and also if the render\n             * context is closed, so let's handle that by putting closeable things\n             * into a handy list and providing a way to close them all.\n             */\n            const closeables: Array<?ICloseable> = [];\n            try {\n                /**\n                 * We are going to need a resource loader so that we can obtain files\n                 * both inside and outside the JSDOM VM.\n                 */\n                const resourceLoader = this._configuration.getResourceLoader(\n                    url,\n                    renderAPI,\n                );\n                closeables.push(resourceLoader);\n\n                // Let's get those files!\n                const files = await this._retrieveTargetFiles(\n                    url,\n                    renderAPI,\n                    resourceLoader,\n                );\n\n                /**\n                 * We want a JSDOM instance for the url we want to render. This is\n                 * where we setup custom resource loading and our virtual console\n                 * too.\n                 */\n                const {JSDOM} = require(\"jsdom\");\n                const {\n                    CloseableVirtualConsole,\n                } = require(\"./closeable-virtual-console.js\");\n                const virtualConsole = new CloseableVirtualConsole(\n                    renderAPI.logger,\n                );\n                const jsdomInstance = new JSDOM(MinimalPage, {\n                    url,\n                    runScripts: \"dangerously\",\n                    resources: (resourceLoader: any),\n                    pretendToBeVisual: true,\n                    virtualConsole,\n                });\n                closeables.push(virtualConsole);\n                closeables.push(jsdomInstance.window);\n\n                /**\n                 * OK, we know this is a JSDOM instance but we want to expose a nice\n                 * wrapper. As part of that wrapper, we want to make it easier to\n                 * run scripts (like our rendering JS code) within the VM context.\n                 * So, let's create a helper for that.\n                 *\n                 * We cast the context to any, because otherwise it is typed as an\n                 * empty object, which makes life annoying.\n                 */\n                const vmContext: any = jsdomInstance.getInternalVMContext();\n\n                /**\n                 * Next, we want to patch timers so we can make sure they don't\n                 * fire after we are done (and so we can catch dangling timers if\n                 * necessary). To do this, we are going to hang the timer API off\n                 * the vmContext and then execute it from inside the context.\n                 * Super magic.\n                 */\n                const tmpFnName = \"__tmp_patchTimers\";\n                const {\n                    patchAgainstDanglingTimers,\n                } = require(\"./patch-against-dangling-timers.js\");\n                vmContext[tmpFnName] = patchAgainstDanglingTimers;\n                const timerGateAPI: IGate = this._runScript(\n                    vmContext,\n                    `${tmpFnName}(window);`,\n                );\n                delete vmContext[tmpFnName];\n                closeables.push(timerGateAPI);\n\n                /**\n                 * At this point, we give our configuration an opportunity to\n                 * modify the render context and capture the return result, which\n                 * can be used to tidy up after we're done.\n                 */\n                const afterRenderTidyUp =\n                    await this._configuration.afterEnvSetup(\n                        url,\n                        files.urls,\n                        renderAPI,\n                        vmContext,\n                    );\n                closeables.push(afterRenderTidyUp);\n\n                /**\n                 * At this point, before loading the files for rendering, we must\n                 * configure the registration point in our render context.\n                 */\n                const {registrationCallbackName} = this._configuration;\n                const registeredCbName = \"__registeredCallback\";\n                vmContext[registrationCallbackName] = (\n                    cb: RenderCallbackFn,\n                ): void => {\n                    vmContext[registrationCallbackName][registeredCbName] = cb;\n                };\n                closeables.push({\n                    close: () => {\n                        delete vmContext[registrationCallbackName];\n                    },\n                });\n\n                /**\n                 * The context is configured. Now we need to load the files into it\n                 * which should cause our registration callback to be invoked.\n                 * We pass the filename here so we can get some nicer stack traces.\n                 */\n                for (const {content, url} of files.files) {\n                    this._runScript(vmContext, content, {filename: url});\n                }\n\n                /**\n                 * With the files all loaded, we should have a registered callback.\n                 * Let's assert that and then invoke the render process.\n                 */\n                if (\n                    typeof vmContext[registrationCallbackName][\n                        registeredCbName\n                    ] !== \"function\"\n                ) {\n                    throw new KAError(\n                        \"No render callback was registered.\",\n                        Errors.Internal,\n                    );\n                }\n\n                /**\n                 * And now we run the registered callback inside the VM.\n                 */\n                const result: RenderResult = await this._runScript(\n                    vmContext,\n                    `\n    const cb = window[\"${registrationCallbackName}\"][\"${registeredCbName}\"];\n    cb();`,\n                );\n\n                /**\n                 * Let's make sure that the rendered function returned something\n                 * resembling a render result.\n                 */\n                if (\n                    result == null ||\n                    !safeHasOwnProperty(result, \"body\") ||\n                    !safeHasOwnProperty(result, \"status\") ||\n                    !safeHasOwnProperty(result, \"headers\")\n                ) {\n                    throw new KAError(\n                        `Malformed render result: ${JSON.stringify(result)}`,\n                        Errors.Internal,\n                    );\n                }\n\n                /**\n                 * After all that, we should have a result, so let's return it and\n                 * let our finally tidy up all the render context we built.\n                 */\n                return result;\n            } finally {\n                /**\n                 * We need to make sure that whatever happens, we tidy everything\n                 * up.\n                 */\n                await this._closeAll(closeables, renderAPI.logger);\n            }\n        };\n}\n"],"mappings":"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"}