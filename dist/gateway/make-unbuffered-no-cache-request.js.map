{"version":3,"sources":["../../src/gateway/make-unbuffered-no-cache-request.js"],"names":["makeUnbufferedNoCacheRequest","options","logger","url","name","version","requestLogger","child","requestedURL","superagent","get","agent","retry","retries","shouldRetry","set","timeout"],"mappings":";;;;;;;AACA;;AAGA;;AACA;;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,4BAA4B,GAAG,CACxCC,OADwC,EAExCC,MAFwC,EAGxCC,GAHwC,KAI9B;AACV,QAAM;AAACC,IAAAA,IAAD;AAAOC,IAAAA;AAAP,MAAkB,4BAAxB;AACA,QAAMC,aAAa,GAAGJ,MAAM,CAACK,KAAP,CAAa;AAC/BC,IAAAA,YAAY,EAAEL;AADiB,GAAb,CAAtB;AAIA,SACIM,oBACKC,GADL,CACSP,GADT,EAEKQ,KAFL,CAEWV,OAAO,CAACU,KAFnB;AAGI;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AAVQ,GAWKC,KAXL,CAYQX,OAAO,CAACY,OAZhB,EAaQ,sCAAgBP,aAAhB,EAA+BL,OAAO,CAACa,WAAvC,CAbR;AAeI;AACZ;AACA;AACA;AACA;AACA;AACA;AArBQ,GAsBKC,GAtBL,CAsBS,YAtBT,EAsBwB,GAAEX,IAAK,KAAIC,OAAQ,GAtB3C,EAuBKW,OAvBL,CAuBaf,OAAO,CAACe,OAvBrB,CADJ;AA0BH,CApCM","sourcesContent":["// @flow\nimport superagent from \"superagent\";\nimport type {Request} from \"superagent\";\nimport type {RequestOptions} from \"./types.js\";\nimport {makeShouldRetry} from \"./make-should-retry.js\";\nimport {getGatewayInfo} from \"../shared/index.js\";\nimport type {Logger} from \"../shared/index.js\";\n\n/**\n * Make a request for a given URL without buffering or caching.\n *\n * This is not intended for direct use. Use makeRequest.\n *\n * @param {RenderGatewayOptions} options The options used to start the gateway.\n * @param {Logger} logger The logger to use.\n * @param {string} url The URL to be requested.\n * @returns {SuperAgentRequest} A superagent request for the URL.\n */\nexport const makeUnbufferedNoCacheRequest = (\n    options: RequestOptions,\n    logger: Logger,\n    url: string,\n): Request => {\n    const {name, version} = getGatewayInfo();\n    const requestLogger = logger.child({\n        requestedURL: url,\n    });\n\n    return (\n        superagent\n            .get(url)\n            .agent(options.agent)\n            /**\n             * Configure retries since superagent can handle this for us.\n             * We give it a callback so we can log the retry and, if we so choose\n             * in the future, decide whether we should allow any more. This would\n             * allow us to short circuit the retry count (the max retries still\n             * takes precedence over our callback response, so we can't retry\n             * forever).\n             */\n            .retry(\n                options.retries,\n                makeShouldRetry(requestLogger, options.shouldRetry),\n            )\n            /**\n             * We add a user agent header so that we can easily identify our\n             * requests in logs.\n             *\n             * The header has a form like:\n             *     SERVICE_NAME_HERE (VERSION_STRING_HERE)\n             */\n            .set(\"User-Agent\", `${name} (${version})`)\n            .timeout(options.timeout)\n    );\n};\n"],"file":"make-unbuffered-no-cache-request.js"}