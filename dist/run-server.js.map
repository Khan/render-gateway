{"version":3,"file":"run-server.js","names":["_wonderStuffServer","require","_express","_interopRequireDefault","_expressAsyncHandler","_getLogLevel","_makeRenderHandler","_getRequestAuthentication","obj","__esModule","default","runServer","options","authentication","renderEnvironment","uncaughtRenderErrorHandler","defaultRenderErrorResponse","host","port","cloudOptions","keepAliveTimeout","name","process","env","NODE_ENV","getRuntimeMode","KA_IS_DEV_SERVER","app","express","get","asyncHandler","makeRenderHandler","set","startServer","mode","logLevel","getLogLevel","integrations","profiler","requestAuthentication","getRequestAuthentication","exports"],"sources":["../src/run-server.js"],"sourcesContent":["// @flow\nimport {startServer, getRuntimeMode} from \"@khanacademy/wonder-stuff-server\";\nimport express from \"express\";\nimport asyncHandler from \"express-async-handler\";\nimport type {RenderGatewayOptions, Request, Response} from \"./types.js\";\nimport {getLogLevel} from \"./get-log-level.js\";\nimport {makeRenderHandler} from \"./handlers/make-render-handler.js\";\nimport {getRequestAuthentication} from \"./get-request-authentication.js\";\n\n/**\n * Run the render-gateway server using the provided options.\n *\n * @param {RenderGatewayOptions} options The options that define how the\n * render gateway will operate.\n * @returns {Promise<void>} The promise of working.\n */\nexport const runServer = async (\n    options: RenderGatewayOptions,\n): Promise<void> => {\n    const {\n        authentication,\n        renderEnvironment,\n        uncaughtRenderErrorHandler,\n        defaultRenderErrorResponse,\n        host,\n        port,\n        cloudOptions,\n        keepAliveTimeout,\n        name,\n    } = options;\n\n    if (process.env.NODE_ENV !== getRuntimeMode()) {\n        process.env.NODE_ENV =\n            process.env.KA_IS_DEV_SERVER === \"1\" ? \"development\" : \"production\";\n    }\n\n    const app = express<Request, Response>()\n        /**\n         * This is our render route. See the handler to learn how the magic\n         * happens.\n         */\n        .get(\n            \"/_render\",\n            asyncHandler(\n                makeRenderHandler(\n                    renderEnvironment,\n                    uncaughtRenderErrorHandler,\n                    defaultRenderErrorResponse,\n                ),\n            ),\n        );\n\n    /**\n     * Added this to support forwarding proxies in case we need it, per the\n     * documentation:\n     *\n     * https://cloud.google.com/appengine/docs/standard/nodejs/runtime#https_and_forwarding_proxies\n     */\n    app.set(\"trust proxy\", true);\n\n    // Start the gateway.\n    await startServer(\n        {\n            mode: getRuntimeMode(),\n            logLevel: getLogLevel(),\n            host,\n            port,\n            keepAliveTimeout,\n            name,\n            integrations: {\n                profiler: cloudOptions?.profiler,\n            },\n            requestAuthentication: await getRequestAuthentication(\n                authentication,\n            ),\n        },\n        app,\n    );\n};\n"],"mappings":";;;;;;AACA,IAAAA,kBAAA,GAAAC,OAAA;AACA,IAAAC,QAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,oBAAA,GAAAD,sBAAA,CAAAF,OAAA;AAEA,IAAAI,YAAA,GAAAJ,OAAA;AACA,IAAAK,kBAAA,GAAAL,OAAA;AACA,IAAAM,yBAAA,GAAAN,OAAA;AAAyE,SAAAE,uBAAAK,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAEzE;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMG,SAAS,GAAG,MACrBC,OAA6B,IACb;EAChB,MAAM;IACFC,cAAc;IACdC,iBAAiB;IACjBC,0BAA0B;IAC1BC,0BAA0B;IAC1BC,IAAI;IACJC,IAAI;IACJC,YAAY;IACZC,gBAAgB;IAChBC;EACJ,CAAC,GAAGT,OAAO;EAEX,IAAIU,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,IAAAC,iCAAc,GAAE,EAAE;IAC3CH,OAAO,CAACC,GAAG,CAACC,QAAQ,GAChBF,OAAO,CAACC,GAAG,CAACG,gBAAgB,KAAK,GAAG,GAAG,aAAa,GAAG,YAAY;EAC3E;EAEA,MAAMC,GAAG,GAAG,IAAAC,gBAAO;EACf;AACR;AACA;AACA,KAHQ,CAICC,GAAG,CACA,UAAU,EACV,IAAAC,4BAAY,EACR,IAAAC,oCAAiB,EACbjB,iBAAiB,EACjBC,0BAA0B,EAC1BC,0BAA0B,CAC7B,CACJ,CACJ;;EAEL;AACJ;AACA;AACA;AACA;AACA;EACIW,GAAG,CAACK,GAAG,CAAC,aAAa,EAAE,IAAI,CAAC;;EAE5B;EACA,MAAM,IAAAC,8BAAW,EACb;IACIC,IAAI,EAAE,IAAAT,iCAAc,GAAE;IACtBU,QAAQ,EAAE,IAAAC,wBAAW,GAAE;IACvBnB,IAAI;IACJC,IAAI;IACJE,gBAAgB;IAChBC,IAAI;IACJgB,YAAY,EAAE;MACVC,QAAQ,EAAEnB,YAAY,aAAZA,YAAY,uBAAZA,YAAY,CAAEmB;IAC5B,CAAC;IACDC,qBAAqB,EAAE,MAAM,IAAAC,kDAAwB,EACjD3B,cAAc;EAEtB,CAAC,EACDc,GAAG,CACN;AACL,CAAC;AAACc,OAAA,CAAA9B,SAAA,GAAAA,SAAA"}