{"version":3,"sources":["../src/run-server.js"],"names":["runServer","options","authentication","requests","_","remainingOptions","app","use","process","env","GAE_VERSION","get","renderHandler","gatewayOptions","mode","logger"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AAGA;;AACA;;AACA;;AACA;;;;;;;;;;;;;;AAEA;;;AAGO,MAAMA,SAAS,GAAG,MACrBC,OADqB,IAEL;AAChB,QAAM;AAACC,IAAAA,cAAD;AAAiBC,IAAAA,QAAQ,EAAEC;AAA3B,MAAqDH,OAA3D;AAAA,QAAuCI,gBAAvC,4BAA2DJ,OAA3D;;AAEA,QAAMK,GAAG,GAAG,wBACPC,GADO;AAEJ;;;;AAIA,uCACIC,OAAO,CAACC,GAAR,CAAYC,WAAZ,IAA2B,kBAD/B,CANI;AAUR;;;;AAVQ,GAcPH,GAdO,EAcH,MAAM,0DAA0BL,cAA1B,CAdH;AAeR;;;;AAfQ,GAmBPS,GAnBO,CAmBH,IAnBG,EAmBG,kCAAaC,4BAAb,CAnBH,CAAZ,CAHgB,CAwBhB;;AACA,QAAMC,cAA8B;AAChCC,IAAAA,IAAI,EAAE,qCAD0B;AAEhCC,IAAAA,MAAM,EAAE;AAFwB,KAG7BV,gBAH6B,CAApC;;AAKA,2BAAgCQ,cAAhC,EAAgDP,GAAhD;AACH,CAjCM","sourcesContent":["// @flow\nimport express from \"express\";\nimport asyncHandler from \"express-async-handler\";\nimport {startGateway} from \"./shared/index.js\";\nimport type {RenderGatewayOptions, Request, Response} from \"./types.js\";\nimport type {GatewayOptions} from \"./shared/index.js\";\nimport {getLogger, makeCommonServiceRouter} from \"./ka-shared/index.js\";\nimport {getRuntimeMode} from \"./ka-shared/get-runtime-mode.js\";\nimport {makeCheckSecretMiddleware} from \"./middleware/make-check-secret-middleware.js\";\nimport {renderHandler} from \"./handlers/render-handler.js\";\n\n/**\n * Run the render-gateway server using the provided options.\n */\nexport const runServer = async (\n    options: RenderGatewayOptions,\n): Promise<void> => {\n    const {authentication, requests: _, ...remainingOptions} = options;\n\n    const app = express<Request, Response>()\n        .use(\n            /**\n             * This sets up the /_api/ route handlers that are used by the KA\n             * deployment system.\n             */\n            makeCommonServiceRouter(\n                process.env.GAE_VERSION || \"fake-dev-version\",\n            ),\n        )\n        /**\n         * This adds a check that requests below this point are coming from\n         * a known source.\n         */\n        .use(await makeCheckSecretMiddleware(authentication))\n        /**\n         * This is our render route. This will handle all remaining gets as\n         * render requests and response accordingly.\n         */\n        .get(\"/*\", asyncHandler(renderHandler));\n\n    // Start the gateway.\n    const gatewayOptions: GatewayOptions = {\n        mode: getRuntimeMode(),\n        logger: getLogger(),\n        ...remainingOptions,\n    };\n    startGateway<Request, Response>(gatewayOptions, app);\n};\n"],"file":"run-server.js"}