{"version":3,"file":"trace-impl.js","names":["traceImpl","logger","action","message","tracer","KAError","Errors","Internal","logMessage","silly","profiler","startTimer","beforeMemory","process","memoryUsage","name","gatewayName","getGatewayInfo","span","createChildSpan","profileLabels","addLabel","value","end","info","afterMemory","getDelta","metadata","getDefaultMetadata","level","done","endSpan"],"sources":["../../src/shared/trace-impl.js"],"sourcesContent":["// @flow\nimport type {Tracer} from \"@google-cloud/trace-agent\";\nimport {getGatewayInfo} from \"./get-gateway-info.js\";\nimport {getDelta} from \"./get-delta.js\";\nimport {getDefaultMetadata} from \"./create-logger.js\";\nimport KAError from \"./ka-error.js\";\nimport {Errors} from \"./errors.js\";\nimport type {Logger, ITraceSession, TraceSessionInfo} from \"./types.js\";\n\n/**\n * Start tracing an event.\n *\n * This will log the start of a trace and open a trace session, which is\n * returned. Use the returned session to end the trace when the traced event is\n * over. The traced event will be logged and also written to the Google Cloud\n * StackDriver Trace agent.\n *\n * Trace logs include metadata about the trace such as duration and memory\n * usage.\n *\n * @param {Logger} logger A logger to use for documention and timing the\n * traced action.\n * @param {string} action The name of the traced action. Keep it short. This\n * should be the name of an action rather than a specific URL, for example. Use\n * addLabel on the returned session or the session info when ending the session\n * to add additional details about the trace.\n * @param {string} message A message that will be logged. This is not included\n * in the traces.\n * @param {Tracer} [tracer] A Google Cloud trace agent tracer which\n * can be used to record the traced action.\n * @returns {ITraceSession} A trace session that the caller should use to\n * indicate when the session is finished.\n */\nexport const traceImpl = (\n    logger: Logger,\n    action: string,\n    message: string,\n    tracer?: Tracer,\n): ITraceSession => {\n    if (!action) {\n        throw new KAError(\n            \"Must provide an action for the trace session.\",\n            Errors.Internal,\n        );\n    }\n    const logMessage = `${action}${message ? `: ${message}` : \"\"}`;\n\n    /**\n     * We are going to use the logger's profiling API (provided by winston).\n     * However, we want to mark the start of the trace as it gives us some\n     * debug information which can be valuable when investigating operations.\n     *\n     * Winston only logs when profiling is done and the optional trace agent\n     * tracer will only show the span if it is ended.\n     *\n     * Since this is noise in most situations, we will log this at the lowest\n     * level of silly.\n     */\n    logger.silly(`TRACE ${logMessage}`);\n\n    /**\n     * Now we start the profiling timer.\n     */\n    const profiler = logger.startTimer();\n    const beforeMemory = process.memoryUsage();\n    const {name: gatewayName} = getGatewayInfo();\n\n    /**\n     * Next, if we were given a tracer, we start a trace section for this so\n     * trace session so that it will appear in Stackdriver Trace.\n     *\n     * We annotate the span with the gateway name so that it is clear in the\n     * trace which spans were created by this API and which were inserted by\n     * other means.\n     */\n    const span = tracer?.createChildSpan({name: `${gatewayName}.${action}`});\n\n    const profileLabels = {};\n    const addLabel = <T>(name: string, value: T): void => {\n        /**\n         * Track this so we can also include it in our logging info.\n         */\n        profileLabels[name] = value;\n\n        /**\n         * Send this label on to the trace span.\n         *\n         * We disable this lint rule as the linter does not appear to\n         * understand the optional chaining.\n         */\n        span?.addLabel(name, value);\n    };\n\n    /**\n     * This is the function that we will return to our caller.\n     * It can then be used to end and record the trace session.\n     */\n    const end = (info?: TraceSessionInfo): void => {\n        const afterMemory = process.memoryUsage();\n\n        /**\n         * Add some session information to the span as labels.\n         *\n         * Flow doesn't trust the inexact objects returned by memoryUsage()\n         * and so `getDelta` isn't typed to handle that. Have to rethink\n         * how to make that work.\n         */\n        // $FlowFixMe[incompatible-call]\n        addLabel(\"/memory/delta\", getDelta(beforeMemory, afterMemory));\n        addLabel(\"/memory/final\", afterMemory);\n\n        /**\n         * We need to build the metadata that we will be logging.\n         * This is a combination of the given info, some custom things we add,\n         * and any profile labels that were added.\n         */\n        const metadata = {\n            /**\n             * We have to add the default metadata because winston does not\n             * include this for profiler.done calls, strangely.\n             *\n             * And we have to recreate it because we might be in a worker\n             * that doesn't have access directly to the root logger that has\n             * the default data.\n             */\n            ...getDefaultMetadata(),\n            ...profileLabels,\n            ...info,\n            message: `TRACED ${logMessage}`,\n            level: info?.level || \"debug\",\n        };\n\n        /**\n         * Let's mark our profile as done.\n         *\n         * We include the session info object, but make sure to set the level\n         * and message ourselves.\n         */\n        profiler.done(metadata);\n\n        /**\n         * If we started a tracer span, let's end it.\n         *\n         * We disable this lint rule as the linter does not appear to\n         * understand the optional chaining.\n         */\n        span?.endSpan();\n    };\n\n    return {\n        get action() {\n            return action;\n        },\n        addLabel,\n        end,\n    };\n};\n"],"mappings":";;;;;;AAEA;AACA;AACA;AACA;AACA;AAAmC;;AAGnC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,SAAS,GAAG,CACrBC,MAAc,EACdC,MAAc,EACdC,OAAe,EACfC,MAAe,KACC;EAChB,IAAI,CAACF,MAAM,EAAE;IACT,MAAM,IAAIG,gBAAO,CACb,+CAA+C,EAC/CC,cAAM,CAACC,QAAQ,CAClB;EACL;EACA,MAAMC,UAAU,GAAI,GAAEN,MAAO,GAAEC,OAAO,GAAI,KAAIA,OAAQ,EAAC,GAAG,EAAG,EAAC;;EAE9D;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACIF,MAAM,CAACQ,KAAK,CAAE,SAAQD,UAAW,EAAC,CAAC;;EAEnC;AACJ;AACA;EACI,MAAME,QAAQ,GAAGT,MAAM,CAACU,UAAU,EAAE;EACpC,MAAMC,YAAY,GAAGC,OAAO,CAACC,WAAW,EAAE;EAC1C,MAAM;IAACC,IAAI,EAAEC;EAAW,CAAC,GAAG,IAAAC,8BAAc,GAAE;;EAE5C;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;EACI,MAAMC,IAAI,GAAGd,MAAM,aAANA,MAAM,uBAANA,MAAM,CAAEe,eAAe,CAAC;IAACJ,IAAI,EAAG,GAAEC,WAAY,IAAGd,MAAO;EAAC,CAAC,CAAC;EAExE,MAAMkB,aAAa,GAAG,CAAC,CAAC;EACxB,MAAMC,QAAQ,GAAG,CAAIN,IAAY,EAAEO,KAAQ,KAAW;IAClD;AACR;AACA;IACQF,aAAa,CAACL,IAAI,CAAC,GAAGO,KAAK;;IAE3B;AACR;AACA;AACA;AACA;AACA;IACQJ,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAEG,QAAQ,CAACN,IAAI,EAAEO,KAAK,CAAC;EAC/B,CAAC;;EAED;AACJ;AACA;AACA;EACI,MAAMC,GAAG,GAAIC,IAAuB,IAAW;IAC3C,MAAMC,WAAW,GAAGZ,OAAO,CAACC,WAAW,EAAE;;IAEzC;AACR;AACA;AACA;AACA;AACA;AACA;IACQ;IACAO,QAAQ,CAAC,eAAe,EAAE,IAAAK,kBAAQ,EAACd,YAAY,EAAEa,WAAW,CAAC,CAAC;IAC9DJ,QAAQ,CAAC,eAAe,EAAEI,WAAW,CAAC;;IAEtC;AACR;AACA;AACA;AACA;IACQ,MAAME,QAAQ,GAAG;MACb;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;MACY,GAAG,IAAAC,gCAAkB,GAAE;MACvB,GAAGR,aAAa;MAChB,GAAGI,IAAI;MACPrB,OAAO,EAAG,UAASK,UAAW,EAAC;MAC/BqB,KAAK,EAAE,CAAAL,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAEK,KAAK,KAAI;IAC1B,CAAC;;IAED;AACR;AACA;AACA;AACA;AACA;IACQnB,QAAQ,CAACoB,IAAI,CAACH,QAAQ,CAAC;;IAEvB;AACR;AACA;AACA;AACA;AACA;IACQT,IAAI,aAAJA,IAAI,uBAAJA,IAAI,CAAEa,OAAO,EAAE;EACnB,CAAC;EAED,OAAO;IACH,IAAI7B,MAAM,GAAG;MACT,OAAOA,MAAM;IACjB,CAAC;IACDmB,QAAQ;IACRE;EACJ,CAAC;AACL,CAAC;AAAC"}