{"version":3,"sources":["../../../src/shared/middleware/make-app-engine-request-id-middleware.js"],"names":["makeAppEngineRequestIDMiddleware","defaultLogger","middleware","req","res","next","requestID","requestIDLog","child","log"],"mappings":";;;;;;;AAEA;;AACA;;AAGA;AACA;AACA;AACA;AACO,SAASA,gCAAT,CAGLC,aAHK,EAG0C;AAC7C,QAAMC,UAAU,GAAG,CACfC,GADe,EAEfC,GAFe,EAGfC,IAHe,KAIR;AACP,UAAMC,SAAS,GAAG,kDAAsBH,GAAtB,CAAlB;;AACA,QAAIG,SAAS,IAAI,IAAjB,EAAuB;AACnB;AACAD,MAAAA,IAAI;AACJ;AACH;AAED;AACR;AACA;AACA;;;AACQ,UAAME,YAAY,GAAG,wCAAiBN,aAAjB,EAAgCE,GAAhC,EAAqCK,KAArC,CAA2C;AAC5DF,MAAAA;AAD4D,KAA3C,CAArB;AAGA;AACR;AACA;AACA;;AACQH,IAAAA,GAAG,CAACM,GAAJ,GAAUF,YAAV;AACAF,IAAAA,IAAI;AACP,GAzBD;;AA0BA,SAAOH,UAAP;AACH","sourcesContent":["// @flow\nimport type {$Response, $Request, Middleware, NextFunction} from \"express\";\nimport {getAppEngineRequestID} from \"../get-app-engine-request-id.js\";\nimport {getRequestLogger} from \"../get-request-logger.js\";\nimport type {Logger, RequestWithLog} from \"../types.js\";\n\n/**\n * Create a middleware that sets the log property of a request to a logger\n * that will attach the GAE requestID to the log metadata.\n */\nexport function makeAppEngineRequestIDMiddleware<\n    TReq: RequestWithLog<$Request>,\n    TRes: $Response,\n>(defaultLogger: Logger): Middleware<TReq, TRes> {\n    const middleware = <TReq: RequestWithLog<$Request>, TRes: $Response>(\n        req: TReq,\n        res: TRes,\n        next: NextFunction,\n    ): void => {\n        const requestID = getAppEngineRequestID(req);\n        if (requestID == null) {\n            // We couldn't get the GAE request ID, so let's skip on.\n            next();\n            return;\n        }\n\n        /**\n         * We have a requestID and we know req.log exists, so let's set\n         * req.log to a derived child logger that adds the requestID metadata.\n         */\n        const requestIDLog = getRequestLogger(defaultLogger, req).child({\n            requestID,\n        });\n        /*\n         * NOTE: the $Request type doesn't have a log field, officially.\n         * However, we know that the Google middleware adds it.\n         */\n        req.log = requestIDLog;\n        next();\n    };\n    return middleware;\n}\n"],"file":"make-app-engine-request-id-middleware.js"}