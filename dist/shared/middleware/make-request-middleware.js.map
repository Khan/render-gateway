{"version":3,"sources":["../../../src/shared/middleware/make-request-middleware.js"],"names":["makeRequestMiddleware","mode","logger","lw","express","makeMiddleware","LoggingWinston","Promise","resolve","expressWinston","level","winstonInstance","expressFormat","colorize","meta"],"mappings":";;;;;;;AACA;;AACA;;;;;;;;AAKA;AACA;AACA;AACO,MAAMA,qBAAqB,GAAG,CACjCC,IADiC,EAEjCC,MAFiC,KAGC;AAClC,MAAID,IAAI,KAAK,YAAb,EAA2B;AACvB;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACQ,WAAOE,EAAE,CAACC,OAAH,CAAWC,cAAX,CAA0BH,MAA1B,EAAkC,IAAIC,EAAE,CAACG,cAAP,EAAlC,CAAP;AACH;AAED;AACJ;AACA;;;AACI,SAAOC,OAAO,CAACC,OAAR,CACHC,wBAAeP,MAAf,CAAsB;AAClB;AACZ;AACA;AACA;AACA;AACYQ,IAAAA,KAAK,EAAE,MANW;;AAQlB;AACZ;AACA;AACYC,IAAAA,eAAe,EAAET,MAXC;AAYlBU,IAAAA,aAAa,EAAE,IAZG;AAalBC,IAAAA,QAAQ,EAAE,IAbQ;AAclBC,IAAAA,IAAI,EAAE;AAdY,GAAtB,CADG,CAAP;AAkBH,CArCM","sourcesContent":["// @flow\nimport * as lw from \"@google-cloud/logging-winston\";\nimport expressWinston from \"express-winston\";\n\nimport type {Middleware, $Request, $Response} from \"express\";\nimport type {Logger, Runtime} from \"../types.js\";\n\n/**\n * Create middleware for tracking requests.\n */\nexport const makeRequestMiddleware = <TReq: $Request, TRes: $Response>(\n    mode: Runtime,\n    logger: Logger,\n): Promise<Middleware<TReq, TRes>> => {\n    if (mode === \"production\") {\n        /**\n         * In production, we're using the Google middleware. This adds the\n         * log property to the request, allowing us to associate log entries\n         * with a request trace, if the request is being traced.\n         *\n         * WORKAROUND: We must pass the corresponding transport here or it will\n         * get added for us and then we'll have double logging.\n         */\n        return lw.express.makeMiddleware(logger, new lw.LoggingWinston());\n    }\n\n    /**\n     * In all other cases, we use express-winston to log requests for us.\n     */\n    return Promise.resolve(\n        expressWinston.logger({\n            /**\n             * Specify the level that this logger logs at.\n             * (use a function to dynamically change level based on req and res)\n             *     `function(req, res) { return String; }`\n             */\n            level: \"info\",\n\n            /**\n             * Use the logger we already set up.\n             */\n            winstonInstance: logger,\n            expressFormat: true,\n            colorize: true,\n            meta: false,\n        }),\n    );\n};\n"],"file":"make-request-middleware.js"}