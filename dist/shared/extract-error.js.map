{"version":3,"file":"extract-error.js","names":["extractError","error","addPropPrimitives","targetObj","sourceError","props","addedProps","key","value","Object","entries","freeze","response","errorMessage","stack","errorString","toString","message","name"],"sources":["../../src/shared/extract-error.js"],"sourcesContent":["// @flow\nimport type {AmbiguousError, SimplifiedError} from \"./types.js\";\n\n/**\n * Extract the root cause error from an ambiguous error.\n *\n * This takes an ambiguous error representation and attempts to turn it into\n * a less ambiguous version.\n *\n * @param {AmbiguousError} error An object or string that represents an error.\n * @returns {SimplifiedError} A simplified error object.\n */\nexport function extractError(\n    error: AmbiguousError,\n): $ReadOnly<SimplifiedError> {\n    // The error is a string, so we just use that.\n    if (typeof error === \"string\") {\n        return {error};\n    }\n\n    const addPropPrimitives = (\n        targetObj: SimplifiedError,\n        sourceError: AmbiguousError,\n    ): $ReadOnly<SimplifiedError> => {\n        const props: {...$NonMaybeType<SimplifiedError[\"props\"]>} = {};\n        let addedProps = false;\n        // This just gets any primitive (number/string/boolean/etc.) values off\n        // the error that might be useful for diagnosing things and coerces them\n        // to strings.\n        for (const [key, value] of Object.entries(error)) {\n            switch (key) {\n                case \"message\":\n                case \"stack\":\n                case \"name\":\n                    // This method will not pick up values behind getters which,\n                    // for normal Error class objects, means this should skip\n                    // things like message and stack, but let's filter them\n                    // out just in case.\n                    continue;\n\n                default:\n                    break;\n            }\n            switch (typeof value) {\n                case \"number\":\n                case \"boolean\":\n                case \"string\":\n                    addedProps = true;\n                    props[key] = value;\n                    break;\n\n                default:\n                    // More complex things are ignored. We're not looking\n                    // to gather all the info.\n                    break;\n            }\n        }\n        if (addedProps) {\n            // It's OK, we want everyone else to see this as not writable,\n            // but know what we're doing.\n            // $FlowIgnore[cannot-write]\n            targetObj.props = props;\n        }\n        return Object.freeze(targetObj);\n    };\n\n    // The error has a response property. This is the style of superagent\n    // failures which sometimes carry the response as a property.\n    if (error.response && typeof error.response.error === \"string\") {\n        const {\n            response: {error: errorMessage},\n        } = error;\n        return addPropPrimitives(\n            {\n                error: errorMessage,\n                stack: error.stack,\n            },\n            error,\n        );\n    }\n\n    // The error references a child error, let's use that.\n    if (error.error && error !== error.error) {\n        return extractError((error.error: any));\n    }\n\n    // It seems it's a regular error.\n    // `toString` should give us a nice error message. If not, we can try\n    // error.message.\n    const errorString = error.toString();\n    return addPropPrimitives(\n        {\n            /**\n             * If the toString just gave us the generic object response,\n             * then try error.message, and if that doesn't work, try the error.name.\n             * If that doesn't exist, fallback to a basic string.\n             */\n            error:\n                errorString === \"[object Object]\"\n                    ? error.message || error.name || \"Unknown\"\n                    : errorString,\n            stack: error.stack,\n        },\n        error,\n    );\n}\n"],"mappings":";;;;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,YAAY,CACxBC,KAAqB,EACK;EAC1B;EACA,IAAI,OAAOA,KAAK,KAAK,QAAQ,EAAE;IAC3B,OAAO;MAACA;IAAK,CAAC;EAClB;EAEA,MAAMC,iBAAiB,GAAG,CACtBC,SAA0B,EAC1BC,WAA2B,KACE;IAC7B,MAAMC,KAAmD,GAAG,CAAC,CAAC;IAC9D,IAAIC,UAAU,GAAG,KAAK;IACtB;IACA;IACA;IACA,KAAK,MAAM,CAACC,GAAG,EAAEC,KAAK,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACT,KAAK,CAAC,EAAE;MAC9C,QAAQM,GAAG;QACP,KAAK,SAAS;QACd,KAAK,OAAO;QACZ,KAAK,MAAM;UACP;UACA;UACA;UACA;UACA;QAEJ;UACI;MAAM;MAEd,QAAQ,OAAOC,KAAK;QAChB,KAAK,QAAQ;QACb,KAAK,SAAS;QACd,KAAK,QAAQ;UACTF,UAAU,GAAG,IAAI;UACjBD,KAAK,CAACE,GAAG,CAAC,GAAGC,KAAK;UAClB;QAEJ;UACI;UACA;UACA;MAAM;IAElB;IACA,IAAIF,UAAU,EAAE;MACZ;MACA;MACA;MACAH,SAAS,CAACE,KAAK,GAAGA,KAAK;IAC3B;IACA,OAAOI,MAAM,CAACE,MAAM,CAACR,SAAS,CAAC;EACnC,CAAC;;EAED;EACA;EACA,IAAIF,KAAK,CAACW,QAAQ,IAAI,OAAOX,KAAK,CAACW,QAAQ,CAACX,KAAK,KAAK,QAAQ,EAAE;IAC5D,MAAM;MACFW,QAAQ,EAAE;QAACX,KAAK,EAAEY;MAAY;IAClC,CAAC,GAAGZ,KAAK;IACT,OAAOC,iBAAiB,CACpB;MACID,KAAK,EAAEY,YAAY;MACnBC,KAAK,EAAEb,KAAK,CAACa;IACjB,CAAC,EACDb,KAAK,CACR;EACL;;EAEA;EACA,IAAIA,KAAK,CAACA,KAAK,IAAIA,KAAK,KAAKA,KAAK,CAACA,KAAK,EAAE;IACtC,OAAOD,YAAY,CAAEC,KAAK,CAACA,KAAK,CAAO;EAC3C;;EAEA;EACA;EACA;EACA,MAAMc,WAAW,GAAGd,KAAK,CAACe,QAAQ,EAAE;EACpC,OAAOd,iBAAiB,CACpB;IACI;AACZ;AACA;AACA;AACA;IACYD,KAAK,EACDc,WAAW,KAAK,iBAAiB,GAC3Bd,KAAK,CAACgB,OAAO,IAAIhB,KAAK,CAACiB,IAAI,IAAI,SAAS,GACxCH,WAAW;IACrBD,KAAK,EAAEb,KAAK,CAACa;EACjB,CAAC,EACDb,KAAK,CACR;AACL"}