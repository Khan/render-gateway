{"version":3,"file":"extract-error.js","names":["extractError","error","addPropPrimitives","targetObj","sourceError","props","addedProps","key","value","Object","entries","freeze","response","errorMessage","stack","errorString","toString","message","name"],"sources":["../../src/shared/extract-error.js"],"sourcesContent":["// @flow\nimport type {AmbiguousError, SimplifiedError} from \"./types.js\";\n\n/**\n * Extract the root cause error from an ambiguous error.\n *\n * This takes an ambiguous error representation and attempts to turn it into\n * a less ambiguous version.\n *\n * @param {AmbiguousError} error An object or string that represents an error.\n * @returns {SimplifiedError} A simplified error object.\n */\nexport function extractError(\n    error: AmbiguousError,\n): $ReadOnly<SimplifiedError> {\n    // The error is a string, so we just use that.\n    if (typeof error === \"string\") {\n        return {error};\n    }\n\n    const addPropPrimitives = (\n        targetObj: SimplifiedError,\n        sourceError,\n    ): $ReadOnly<SimplifiedError> => {\n        const props = {};\n        let addedProps = false;\n        // This just gets any primitive (number/string/boolean/etc.) values off\n        // the error that might be useful for diagnosing things and coerces them\n        // to strings.\n        for (const [key, value] of Object.entries(error)) {\n            switch (key) {\n                case \"message\":\n                case \"stack\":\n                case \"name\":\n                    // This method will not pick up values behind getters which,\n                    // for normal Error class objects, means this should skip\n                    // things like message and stack, but let's filter them\n                    // out just in case.\n                    continue;\n\n                default:\n                    break;\n            }\n            switch (typeof value) {\n                case \"number\":\n                case \"boolean\":\n                case \"string\":\n                    addedProps = true;\n                    props[key] = value;\n                    break;\n\n                default:\n                    // More complex things are ignored. We're not looking\n                    // to gather all the info.\n                    break;\n            }\n        }\n        if (addedProps) {\n            // It's OK, we want everyone else to see this as not writable,\n            // but know what we're doing.\n            // $FlowIgnore[cannot-write]\n            targetObj.props = props;\n        }\n        return Object.freeze(targetObj);\n    };\n\n    // The error has a response property. This is the style of superagent\n    // failures which sometimes carry the response as a property.\n    if (error.response && typeof error.response.error === \"string\") {\n        const {\n            response: {error: errorMessage},\n        } = error;\n        return addPropPrimitives(\n            {\n                error: errorMessage,\n                stack: error.stack,\n            },\n            error,\n        );\n    }\n\n    // The error references a child error, let's use that.\n    if (error.error && error !== error.error) {\n        return extractError((error.error: any));\n    }\n\n    // It seems it's a regular error.\n    // `toString` should give us a nice error message. If not, we can try\n    // error.message.\n    const errorString = error.toString();\n    return addPropPrimitives(\n        {\n            /**\n             * If the toString just gave us the generic object response,\n             * then try error.message, and if that doesn't work, try the error.name.\n             * If that doesn't exist, fallback to a basic string.\n             */\n            error:\n                errorString === \"[object Object]\"\n                    ? error.message || error.name || \"Unknown\"\n                    : errorString,\n            stack: error.stack,\n        },\n        error,\n    );\n}\n"],"mappings":";;;;;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,YAAT,CACHC,KADG,EAEuB;EAC1B;EACA,IAAI,OAAOA,KAAP,KAAiB,QAArB,EAA+B;IAC3B,OAAO;MAACA;IAAD,CAAP;EACH;;EAED,MAAMC,iBAAiB,GAAG,CACtBC,SADsB,EAEtBC,WAFsB,KAGO;IAC7B,MAAMC,KAAK,GAAG,EAAd;IACA,IAAIC,UAAU,GAAG,KAAjB,CAF6B,CAG7B;IACA;IACA;;IACA,KAAK,MAAM,CAACC,GAAD,EAAMC,KAAN,CAAX,IAA2BC,MAAM,CAACC,OAAP,CAAeT,KAAf,CAA3B,EAAkD;MAC9C,QAAQM,GAAR;QACI,KAAK,SAAL;QACA,KAAK,OAAL;QACA,KAAK,MAAL;UACI;UACA;UACA;UACA;UACA;;QAEJ;UACI;MAXR;;MAaA,QAAQ,OAAOC,KAAf;QACI,KAAK,QAAL;QACA,KAAK,SAAL;QACA,KAAK,QAAL;UACIF,UAAU,GAAG,IAAb;UACAD,KAAK,CAACE,GAAD,CAAL,GAAaC,KAAb;UACA;;QAEJ;UACI;UACA;UACA;MAXR;IAaH;;IACD,IAAIF,UAAJ,EAAgB;MACZ;MACA;MACA;MACAH,SAAS,CAACE,KAAV,GAAkBA,KAAlB;IACH;;IACD,OAAOI,MAAM,CAACE,MAAP,CAAcR,SAAd,CAAP;EACH,CA5CD,CAN0B,CAoD1B;EACA;;;EACA,IAAIF,KAAK,CAACW,QAAN,IAAkB,OAAOX,KAAK,CAACW,QAAN,CAAeX,KAAtB,KAAgC,QAAtD,EAAgE;IAC5D,MAAM;MACFW,QAAQ,EAAE;QAACX,KAAK,EAAEY;MAAR;IADR,IAEFZ,KAFJ;IAGA,OAAOC,iBAAiB,CACpB;MACID,KAAK,EAAEY,YADX;MAEIC,KAAK,EAAEb,KAAK,CAACa;IAFjB,CADoB,EAKpBb,KALoB,CAAxB;EAOH,CAjEyB,CAmE1B;;;EACA,IAAIA,KAAK,CAACA,KAAN,IAAeA,KAAK,KAAKA,KAAK,CAACA,KAAnC,EAA0C;IACtC,OAAOD,YAAY,CAAEC,KAAK,CAACA,KAAR,CAAnB;EACH,CAtEyB,CAwE1B;EACA;EACA;;;EACA,MAAMc,WAAW,GAAGd,KAAK,CAACe,QAAN,EAApB;EACA,OAAOd,iBAAiB,CACpB;IACI;AACZ;AACA;AACA;AACA;IACYD,KAAK,EACDc,WAAW,KAAK,iBAAhB,GACMd,KAAK,CAACgB,OAAN,IAAiBhB,KAAK,CAACiB,IAAvB,IAA+B,SADrC,GAEMH,WATd;IAUID,KAAK,EAAEb,KAAK,CAACa;EAVjB,CADoB,EAapBb,KAboB,CAAxB;AAeH"}